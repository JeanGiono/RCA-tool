<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA+ 創新問題解決工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 基本樣式 */
        body { font-family: 'Inter', sans-serif; }
        /* 圖表渲染區域 */
        #diagram-render-area {
            position: relative; overflow: auto; padding: 0; background-color: #fff;
            border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 450px; width: 100%; user-select: none;
        }
        #scalable-content-wrapper {
            position: relative; transform-origin: top left; display: inline-block;
            padding: 20px; cursor: grab;
        }
        #scalable-content-wrapper:active { cursor: grabbing; }
        #svg-connector-layer {
            position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 0;
        }
        #rca-diagram-container {
            display: inline-block; text-align: center; position: relative; z-index: 1;
        }

        /* 節點樣式 */
        .rca-node-wrapper {
            display: inline-flex; flex-direction: column; align-items: center;
            margin: 0 1rem; vertical-align: top;
            transition: margin 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .rca-node {
            border: 2px solid #4b5563; padding: 0.6rem 1.1rem;
            margin-top: 30px; margin-bottom: 15px;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            display: inline-flex; flex-direction: column; align-items: center;
            max-width: 350px; border-radius: 0.375rem; position: relative;
            z-index: 1; background-color: #ffffff; overflow-wrap: break-word;
            transition: opacity 0.3s ease-in-out, border-color 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        .rca-node.dimmed { opacity: 0.3; }
        .rca-node-content {
            display: flex; flex-direction: column; gap: 0.4rem; width: 100%; align-items: center;
        }
        .rca-node-header {
            display: flex; align-items: center; justify-content: center;
            gap: 0.4rem; width: 100%; position: relative; margin-bottom: 0.25rem;
        }
        .rca-node-icon {
            font-weight: bold; font-size: 0.85em; padding: 0.2em 0.4em; border-radius: 50%;
            color: white; position: absolute; top: 0.4rem; right: 0.4rem;
            min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
            border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 10; transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        .node-badge {
            font-size: 0.65em; font-weight: bold; color: #374151;
            background-color: #e5e7eb; padding: 0.15rem 0.35rem; border-radius: 0.25rem;
            align-self: center; margin-left: 0.25rem;
        }
        .abc-badge {
            position: absolute; top: 0.4rem; left: 0.4rem; font-size: 0.7em; font-weight: bold;
            padding: 0.15em 0.4em; border-radius: 0.25rem; color: white; border: 1px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: 10;
        }
        .abc-badge-A { background-color: #ef4444; }
        .abc-badge-B { background-color: #f97316; }
        .abc-badge-C { background-color: #f59e0b; }

        .rca-node-text {
            font-weight: 500; font-size: 0.9rem; text-align: center;
            overflow-wrap: break-word; line-height: 1.4; box-sizing: border-box;
        }
        .rca-node:not(.rca-node-positive-effect):not(.rca-node-negative-effect) .rca-node-text {
            width: 9em; padding-right: 2.5em; padding-left: 1.5em;
            display: inline-block; vertical-align: middle;
        }
        .rca-node-positive-effect .rca-node-text,
        .rca-node-negative-effect .rca-node-text {
            display: block; width: 100%; padding-right: 3em;
        }

        .selected-items-list {
            font-size: 0.75rem; color: #374151; margin-top: 0.5rem;
            padding-top: 0.375rem; border-top: 1px dashed #d1d5db; width: 100%; text-align: left;
        }
        .selected-items-list strong { display: block; margin-bottom: 0.25rem; color: #111827; }
        .selected-items-list ul { list-style-type: disc; margin-left: 1.25rem; padding-left: 0.25rem; }
        .selected-items-list li { margin-bottom: 0.25rem; }
        .selected-items-list .solution-text { color: #059669; margin-left: 0.3rem; font-style: italic;}
        .engineering-param-display { font-size: 0.7rem; color: #4b5563; margin-top: 0.25rem; }
        .ideality-score-display { font-size: 0.7rem; color: #1d4ed8; margin-top: 0.25rem; font-weight: bold;}

        /* 節點類型顏色 */
        .rca-node-initial-problem { background-color: #fee2e2; border-color: #ef4444; }
        .rca-node-initial-problem .rca-node-icon { background-color: #ef4444; }
        .rca-node-cause { background-color: #fef9c3; border-color: #f59e0b; }
        .rca-node-cause .rca-node-icon.contradictory { background-color: #8b5cf6; }
        .rca-node-positive-effect { background-color: #dbeafe; border-color: #3b82f6; border-radius: 0.375rem; padding: 0.6rem 1.1rem; } /* Changed to match cause node border-radius */
        .rca-node-positive-effect .rca-node-icon { background-color: #2563eb; }
        .rca-node-negative-effect { background-color: #ffedd5; border-color: #f97316; border-radius: 0.375rem; padding: 0.6rem 1.1rem; } /* Changed to match cause node border-radius */
        .rca-node-negative-effect .rca-node-icon { background-color: #f97316; }
        /* Added contradictory style for effect nodes */
        .rca-node-positive-effect .rca-node-icon.contradictory,
        .rca-node-negative-effect .rca-node-icon.contradictory { background-color: #8b5cf6; }


        .rca-children-container {
            display: flex; flex-direction: row; justify-content: center; align-items: flex-start;
            margin-top: 15px; position: relative; padding-top: 25px; width: max-content;
        }

        /* 動作按鈕 */
        .rca-node-actions {
            display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem;
            border-top: 1px solid #e5e7eb; padding-top: 0.5rem; width: 100%; justify-content: flex-start;
        }
        .action-button {
            background-color: #6b7280; color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem;
            font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .action-button:hover:not(:disabled) { background-color: #4b5563; }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .action-button.add-cause { background-color: #3b82f6; } .action-button.add-cause:hover:not(:disabled) { background-color: #2563eb; }
        .action-button.add-positive { background-color: #10b981; } .action-button.add-positive:hover:not(:disabled) { background-color: #059669; }
        .action-button.add-negative { background-color: #f97316; } .action-button.add-negative:hover:not(:disabled) { background-color: #ea580c; }
        .action-button.toggle-nc { background-color: #a855f7; } .action-button.toggle-nc:hover:not(:disabled) { background-color: #9333ea; }
        .action-button.set-abc { background-color: #14b8a6; } .action-button.set-abc:hover:not(:disabled) { background-color: #0d9488; }
        .action-button.set-triz { background-color: #ec4899; } .action-button.set-triz:hover:not(:disabled) { background-color: #db2777; }
        .action-button.set-and-sources { background-color: #6d28d9; } .action-button.set-and-sources:hover:not(:disabled) { background-color: #5b21b6; }
        .action-button.edit-node { background-color: #f59e0b; } .action-button.edit-node:hover:not(:disabled) { background-color: #d97706; }
        .action-button.set-parameters { background-color: #0ea5e9; } .action-button.set-parameters:hover:not(:disabled) { background-color: #0284c7; }
        .remove-button { background-color: #ef4444; } .remove-button:hover:not(:disabled) { background-color: #dc2626; }

        /* 輸入組件 */
        .input-group-container { margin-top: 0.5rem; width: calc(100% - 1rem); }
        .input-group {
            display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem;
            border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb;
        }
        .input-field, .select-field {
            border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem;
            font-size: 0.875rem; width: 100%;
        }
        .save-button { background-color: #065f46; color: white; } .save-button:hover:not(:disabled) { background-color: #047857; }
        .save-edit-button { background-color: #065f46; color: white; } .save-edit-button:hover:not(:disabled) { background-color: #047857; }

        /* 資料表格 */
        .data-table-section { margin-top: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td {
            border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem;
            text-align: center; vertical-align: middle;
        }
        .data-table th { background-color: #e5e7eb; font-weight: 600; }
        .data-table td { background-color: white; }
        .data-table td:first-child, .data-table th:first-child { text-align: left; }
        .data-table .abc-select { padding: 0.25rem; font-size: 0.8rem; border-radius: 0.25rem; border: 1px solid #d1d5db; }
        .data-table .ideality-assess-button { font-size: 0.75rem; padding: 0.25rem 0.5rem; }

        /* 模態視窗 */
        .modal { z-index: 50; }
        .modal-content { position: relative; }
        .modal-close-button {
            position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none;
            font-size: 1.5rem; color: #6b7280; cursor: pointer; line-height: 1;
        }
        .modal-close-button:hover { color: #1f2937; }
        .modal-options-container { max-height: 60vh; overflow-y: auto; }
        .modal-options-container h4 {
            font-weight:600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #374151;
            border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem;
        }
        .modal-options-container h4:first-child { margin-top: 0; }
        .principle-solution-input {
            width: calc(100% - 2rem); margin-left: 1.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem;
            padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem;
        }

        /* 縮放控制 */
        .zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .zoom-controls span { font-size: 0.875rem; color: #4b5563; min-width: 50px; text-align: center; }

        /* 下拉選單 */
        .dropdown-content {
            display: none; position: absolute; background-color: #f9f9f9;
            min-width: 230px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10; border-radius: 0.375rem; padding: 0.5rem 0;
        }
        #sidebar-file-menu-container > #file-dropdown-content {
            left: 0; top: 100%; width: 100%; margin-left: 0; z-index: 60;
        }
        .dropdown-content button, .dropdown-content label {
            color: black; padding: 0.75rem 1rem; text-decoration: none; display: block;
            text-align: left; background: none; border: none; width: 100%; font-size: 0.875rem; cursor: pointer;
        }
        .dropdown-content button:hover, .dropdown-content label:hover { background-color: #e5e7eb; }
        .dropdown-content button:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9f9f9; }
        .dropdown-content button i, .dropdown-content label i { margin-right: 0.5rem; width: 1.25rem; text-align: center; }

        /* ABC 篩選按鈕 */
        .abc-filter-button {
            padding: 0.5rem 1rem; border-radius: 0.25rem; font-size: 0.875rem;
            color: white; transition: background-color 0.2s;
        }
        .abc-filter-button.active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .solution-entry {
            border: 1px solid #e5e7eb; padding: 0.75rem; margin-bottom: 0.75rem;
            border-radius: 0.25rem; background-color: #f9fafb;
        }
        .solution-entry label { font-weight: 500; display: block; margin-bottom: 0.25rem;}

        /* 創意景觀圖 */
        #ideas-landscape-controls { margin-bottom: 1rem; }
        #ideas-landscape-chart-container { position: relative; min-height: 300px; }
        #ideas-landscape-no-data-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;
            background-color: #f9fafb; border-radius: 0.375rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* 理想性評估模態視窗 */
        .ideality-criterion { margin-bottom: 0.75rem; }
        .ideality-criterion label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .ideality-criterion input[type="number"], .ideality-criterion select { width: 100%; }
        .ideality-criterion input[type="range"] { width: calc(100% - 3.5rem); margin-right: 0.5rem; vertical-align: middle;}
        .ideality-criterion .range-value { font-size: 0.8rem; display: inline-block; width: 2.5rem; text-align: right;}

        /* 工具提示 */
        .tooltip-container { position: relative; display: inline-block; cursor: help; margin-left: 0.25rem; }
        .tooltip-text {
            visibility: hidden; background-color: #333; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 1;
            bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0;
            transition: opacity 0.3s; min-width: 250px; font-size: 0.75rem;
            line-height: 1.4; box-shadow: 0 2px 8px rgba(0,0,0,0.2); white-space: normal;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent;
        }

        /* TRIZ 建議原理 */
        #suggested-principles-container {
            margin-top: 1rem; padding: 0.75rem; background-color: #f3f4f6;
            border-radius: 0.375rem; border: 1px solid #e5e7eb;
        }
        #suggested-principles-container h5 {
            font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;
        }
        #suggested-principles-list {
            list-style-type: decimal; margin-left: 1.25rem; font-size: 0.85rem; color: #4b5563;
        }
        #suggested-principles-list li { margin-bottom: 0.25rem; }

        /* 儀表板選單 */
        .menu-item {
            display: block; padding: 0.75rem 1rem; border-radius: 0.375rem; color: #d1d5db;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500; cursor: pointer;
        }
        .menu-item:hover, .menu-item.active { background-color: #374151; color: #ffffff; }
        .menu-item.disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent !important; color: #9ca3af !important; }
        .menu-item i.fa-fw { width: 1.25em; text-align: center; }

        /* 自訂準則管理 */
        .criterion-entry {
            display: flex; align-items: center; padding: 0.5rem; background-color: #f0f4f8;
            border-radius: 0.25rem; margin-bottom: 0.5rem; font-size: 0.875rem; border: 1px solid #e2e8f0;
        }
        .criterion-entry span { flex-grow: 1; color: #334155; }
        .criterion-entry button { margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .criterion-form {
            padding: 1rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;
            background-color: #f8fafc; margin-top: 1rem;
        }
        .criterion-form input[type="text"], .criterion-form input[type="number"], .criterion-form textarea {
            width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;
            margin-top: 0.25rem; margin-bottom: 0.75rem; font-size: 0.875rem;
        }
        .criterion-form label { font-size: 0.8rem; font-weight: 500; color: #475569; }
    </style>
</head>
<body class="flex h-screen bg-gray-100">
    <aside id="dashboard-menu" class="w-64 bg-gray-800 text-white p-4 space-y-6 fixed top-0 left-0 h-full z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out shadow-lg overflow-y-auto">
        <div class="text-center py-2 border-b border-gray-700">
            <a href="#" class="flex items-center justify-center">
                <i class="fas fa-rocket fa-2x mr-2 text-sky-400"></i> <h1 class="text-xl font-bold">RCA+ 工具</h1>
            </a>
        </div>
        <nav class="space-y-1">
            <div id="sidebar-file-menu-container" class="relative">
                <a href="#" id="sidebar-file-menu-trigger" class="menu-item group flex justify-between items-center">
                    <span><i class="fas fa-file-alt fa-fw mr-3"></i>檔案</span>
                    <i class="fas fa-caret-down"></i>
                </a>
                <div id="file-dropdown-content" class="dropdown-content">
                    <button id="save-diagram-button"><i class="fas fa-save"></i> 儲存進度 (瀏覽器)</button>
                    <button id="load-diagram-button"><i class="fas fa-folder-open"></i> 載入進度 (瀏覽器)</button>
                    <button id="save-to-file-button"><i class="fas fa-file-download"></i> 儲存至檔案</button>
                    <label for="file-input-for-load" id="load-from-file-label"><i class="fas fa-file-upload"></i> 從檔案載入</label>
                    <input type="file" id="file-input-for-load" accept=".json" style="display: none;">
                </div>
            </div>

            <a href="#" id="menu-item-dashboard-overview" class="menu-item group active"> <i class="fas fa-tachometer-alt fa-fw mr-3"></i>
                儀表板總覽
            </a>
            <a href="#rca-diagram-section" id="menu-item-rca-diagram" class="menu-item group">
                <i class="fas fa-project-diagram fa-fw mr-3"></i>
                RCA+ 分析圖
            </a>
             <hr class="border-gray-700 my-2">
            <span class="px-1 pt-2 pb-1 text-xs font-semibold text-gray-400 uppercase tracking-wider">圖表操作</span>
            <a href="#" id="menu-item-toggle-view" class="menu-item group">
                <i class="fas fa-edit fa-fw mr-3"></i>
                編輯模式
            </a>
            <a href="#" id="menu-item-auto-adjust" class="menu-item group">
                <i class="fas fa-sitemap fa-fw mr-3"></i>
                自動調整節點
            </a>
            <a href="#" id="menu-item-export-png" class="menu-item group">
                <i class="fas fa-image fa-fw mr-3"></i>
                匯出圖檔 (PNG)
            </a>
            <hr class="border-gray-700 my-2">
            <span class="px-1 pt-2 pb-1 text-xs font-semibold text-gray-400 uppercase tracking-wider">分析表格</span>
            <a href="#cause-effect-table-section" id="menu-item-cause-effect-table" class="menu-item group">
                <i class="fas fa-table fa-fw mr-3"></i>
                原因效果表
            </a>
            <a href="#solution-table-section" id="menu-item-solution-table" class="menu-item group">
                <i class="fas fa-lightbulb fa-fw mr-3"></i>
                潛在解決方案表
            </a>
            <a href="#ideas-landscape-section" id="menu-item-ideas-landscape" class="menu-item group">
                <i class="fas fa-map-signs fa-fw mr-3"></i>
                創意景觀圖
            </a>
            <hr class="border-gray-700 my-2">
             <a href="#" id="menu-item-settings" class="menu-item group"> <i class="fas fa-cog fa-fw mr-3"></i>
                設定
            </a>
        </nav>
    </aside>

    <button id="mobile-menu-button" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
        <i class="fas fa-bars"></i>
    </button>

    <main id="main-content-area" class="flex-1 p-4 md:p-8 overflow-y-auto md:ml-64 transition-all duration-300 ease-in-out">
        <div class="container mx-auto max-w-7xl">
            <header class="mb-6 text-center">
                <h1 id="main-tool-title" class="text-2xl md:text-3xl font-bold text-gray-700">RCA+ 根本原因分析工具</h1>
                <p class="text-gray-500 mt-1">視覺化根本原因，支援衝突參數設定、發明原理應用、解決方案ABC分類、創意景觀圖與理想性評估等功能。</p>
            </header>

            <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
                 <div id="problem-input-area">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">1. 設定主要負面效果</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="problem-statement-input" placeholder="輸入觀察到的主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                    </div>
                </div>
                <div id="tool-buttons" class="mt-4 flex flex-col gap-3">
                    <div class="flex flex-wrap gap-2 justify-center items-center">
                        <button id="undo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-undo"></i> 上一步
                        </button>
                        <button id="redo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-redo"></i> 下一步
                        </button>
                        <div class="zoom-controls">
                            <button id="zoom-out-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="縮小"><i class="fas fa-search-minus"></i></button>
                            <span id="zoom-level-display">100%</span>
                            <button id="zoom-in-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="放大"><i class="fas fa-search-plus"></i></button>
                            <button id="reset-zoom-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">重設縮放</button>
                        </div>
                    </div>
                    <!--
                    <div class="flex flex-wrap gap-2 justify-center mt-2">
                        <div id="abc-cause-filter-controls" class="flex gap-2 items-center p-2 bg-gray-100 rounded-md">
                            <span class="text-sm font-medium text-gray-700 mr-1">原因ABC篩選:</span>
                            <button data-filter-type="cause" data-filter="all" class="abc-filter-button bg-gray-500 hover:bg-gray-600 active">全部</button>
                            <button data-filter-type="cause" data-filter="A" class="abc-filter-button bg-red-500 hover:bg-red-600">A類</button>
                            <button data-filter-type="cause" data-filter="B" class="abc-filter-button bg-orange-500 hover:bg-orange-600">B類</button>
                            <button data-filter-type="cause" data-filter="C" class="abc-filter-button bg-amber-500 hover:bg-amber-600">C類</button>
                            <button data-filter-type="cause" data-filter="none" class="abc-filter-button bg-slate-500 hover:bg-slate-600">未分類</button>
                        </div>
                    </div>
                    -->
                </div>
            </section>

            <section id="rca-diagram-section" class="bg-white p-0 md:p-0 rounded-lg shadow min-h-[400px]">
                <h2 class="text-xl font-semibold text-gray-700 my-4 text-center" id="diagram-title" style="display: none;">2. RCA+ 分析圖</h2>
                <div id="diagram-render-area">
                    <div id="scalable-content-wrapper">
                        <div id="rca-diagram-container"></div>
                        <svg id="svg-connector-layer"></svg>
                    </div>
                </div>
            </section>

            <section id="cause-effect-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 原因效果表</h2>
                <table class="data-table">
                    <thead> <tr><th>原因</th><th>ABC分類</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                    <tbody id="cause-effect-table-body"></tbody>
                </table>
            </section>

            <section id="solution-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">4. 潛在解決方案表 (TRIZ應用)</h2>
                    <div id="abc-solution-filter-controls" class="flex gap-1 items-center p-1 bg-gray-100 rounded-md">
                        <span class="text-xs font-medium text-gray-600 mr-1">方案ABC篩選:</span>
                        <button data-filter-type="solution" data-filter="all" class="abc-filter-button text-xs px-2 py-1 bg-gray-500 hover:bg-gray-600 active">全</button>
                        <button data-filter-type="solution" data-filter="A" class="abc-filter-button text-xs px-2 py-1 bg-red-500 hover:bg-red-600">A</button>
                        <button data-filter-type="solution" data-filter="B" class="abc-filter-button text-xs px-2 py-1 bg-orange-500 hover:bg-orange-600">B</button>
                        <button data-filter-type="solution" data-filter="C" class="abc-filter-button text-xs px-2 py-1 bg-amber-500 hover:bg-amber-600">C</button>
                        <button data-filter-type="solution" data-filter="none" class="abc-filter-button text-xs px-2 py-1 bg-slate-500 hover:bg-slate-600">未</button>
                    </div>
                </div>
                <table class="data-table">
                    <thead> <tr><th>衝突節點</th><th>改善參數</th><th>惡化參數</th><th>發明原理</th><th>解決方案描述</th><th>方案ABC分類</th><th>理想性評估</th><th>理想性總分</th></tr> </thead>
                    <tbody id="solution-table-body"></tbody>
                </table>
            </section>

            <section id="ideas-landscape-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">5. 創意景觀圖</h2>
                <div id="ideas-landscape-controls" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-3 bg-gray-50 rounded-md">
                    <div>
                        <label for="landscape-time-threshold" class="block text-sm font-medium text-gray-700">導入所需時間門檻值 (X軸中線):</label>
                        <input type="number" id="landscape-time-threshold" value="10" class="input-field mt-1" placeholder="例如：10 (單位自訂)">
                    </div>
                    <div>
                        <label for="landscape-score-threshold" class="block text-sm font-medium text-gray-700">MCDM分數門檻值 (Y軸中線):</label>
                        <input type="number" id="landscape-score-threshold" value="50" class="input-field mt-1" placeholder="例如：50">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button id="update-ideas-landscape-chart-button" class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md w-full">
                            <i class="fas fa-sync-alt mr-1"></i> 更新圖表
                        </button>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mb-2 p-2 bg-gray-100 rounded-md">
                    <strong>圖形分析說明：</strong>
                    <ul class="list-disc list-inside ml-2">
                        <li>左上 (第二象限): 時間短、總分高 (優先方案)</li>
                        <li>左下 (第三象限): 時間短、總分低 (不值得考慮)</li>
                        <li>右下 (第四象限): 時間長、總分低 (不應執行)</li>
                        <li>右上 (第一象限): 時間長、總分高 (可長期規劃)</li>
                    </ul>
                     <p class="mt-1"><strong>提示：</strong>點的大小可能與成本或理想性相關，點的形狀與ABC分類相關。</p>
                </div>
                <div id="ideas-landscape-chart-container" class="w-full h-[500px] bg-white p-2 rounded shadow">
                    <canvas id="ideas-landscape-chart"></canvas>
                    <div id="ideas-landscape-no-data-message" class="absolute inset-0 flex flex-col items-center justify-center bg-white bg-opacity-90 rounded-lg" style="display: none;">
                        <p class="text-lg font-semibold text-gray-700 mb-2">沒有資料可顯示於創意景觀圖。</p>
                        <p class="text-sm text-gray-600 text-center">請確保您已完成以下步驟：</p>
                        <ul class="list-disc list-inside text-sm text-gray-600 mt-2">
                            <li>為衝突節點新增解決方案。</li>
                            <li>為每個解決方案填寫「導入所需時間」。</li>
                            <li>為每個解決方案進行「理想性評估」，以計算「理想性加權總分」。</li>
                        </ul>
                    </div>
                </div>
            </section>

            <div id="abc-category-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                    <button class="modal-close-button" data-modal-id="abc-category-modal">&times;</button>
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="abc-modal-title">設定原因ABC分類</h3>
                        <p class="text-sm text-gray-600 mb-3 text-center" id="abc-modal-node-text"></p>
                        <div class="flex justify-around">
                            <button data-abc-cause="A" class="action-button bg-red-500 hover:bg-red-600 px-6 py-2">A 類</button>
                            <button data-abc-cause="B" class="action-button bg-orange-500 hover:bg-orange-600 px-6 py-2">B 類</button>
                            <button data-abc-cause="C" class="action-button bg-amber-500 hover:bg-amber-600 px-6 py-2">C 類</button>
                        </div>
                        <div class="mt-4 text-center">
                             <button data-abc-cause="null" class="action-button bg-gray-400 hover:bg-gray-500 px-6 py-2">清除分類</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="triz-solution-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                <div class="modal-content mx-auto p-5 border w-11/12 md:w-3/5 lg:w-3/5 shadow-lg rounded-md bg-white">
                    <button class="modal-close-button" data-modal-id="triz-solution-modal">&times;</button>
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="triz-solution-modal-title">設定衝突參數、解決方案與評估資料</h3>
                        <p id="triz-modal-contradiction-node-text" class="text-sm text-gray-600 my-2 text-center"></p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="improving-parameter-select" class="block text-sm font-medium text-gray-700">改善時特性參數:</label>
                                <select id="improving-parameter-select" class="select-field mt-1"></select>
                            </div>
                            <div>
                                <label for="worsening-parameter-select" class="block text-sm font-medium text-gray-700">惡化時特性參數:</label>
                                <select id="worsening-parameter-select" class="select-field mt-1"></select>
                            </div>
                        </div>

                        <div id="suggested-principles-container" style="display: none;">
                            <h5>建議發明原理 (根據矛盾矩陣):</h5>
                            <ol id="suggested-principles-list"></ol> </div>

                        <h4 class="text-md font-semibold text-gray-800 mt-4 mb-2">解決方案列表:</h4>
                        <div id="solutions-list-container" class="max-h-48 overflow-y-auto mb-3"></div>
                        <button id="add-new-solution-entry-button" class="action-button bg-green-500 hover:bg-green-600 text-sm py-1 px-2 mb-2">
                            <i class="fas fa-plus mr-1"></i> 新增解決方案
                        </button>

                        <div id="edit-solution-entry-container" style="display:none;" class="p-3 border rounded-md bg-gray-50 mb-3">
                            <h5 id="edit-solution-title" class="text-sm font-semibold text-gray-700 mb-2"></h5>
                            <input type="hidden" id="editing-solution-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                                <div>
                                    <label for="solution-principle-select" class="block text-xs font-medium text-gray-700">選擇發明原理:</label>
                                    <select id="solution-principle-select" class="select-field mt-1 text-sm"></select>
                                </div>
                                 <div> </div>
                                <div class="md:col-span-2">
                                    <label for="solution-description-input" class="block text-xs font-medium text-gray-700">方案描述:</label>
                                    <textarea id="solution-description-input" rows="2" class="input-field mt-1 text-sm" placeholder="輸入此原理對應的具體解決方案描述"></textarea>
                                </div>
                                <div>
                                    <label for="solution-time-required-input" class="block text-xs font-medium text-gray-700">導入所需時間 (單位自訂):</label>
                                    <input type="number" id="solution-time-required-input" class="input-field mt-1 text-sm" placeholder="例如: 5">
                                </div>
                                <div>
                                    <label for="solution-mcdm-score-input" class="block text-xs font-medium text-gray-700">理想性加權總分 (MCDM):</label>
                                    <input type="text" id="solution-mcdm-score-input" class="input-field mt-1 text-sm" placeholder="請進行理想性評估" readonly>
                                </div>
                                 <div>
                                    <label for="solution-cost-input" class="block text-xs font-medium text-gray-700">預估成本 (可選, 單位自訂):</label>
                                    <input type="number" id="solution-cost-input" class="input-field mt-1 text-sm" placeholder="例如: 1000">
                                </div>
                            </div>
                            <div class="mt-3 text-right">
                                <button id="cancel-edit-solution-button" class="action-button bg-gray-400 hover:bg-gray-500 text-xs py-1 px-2 mr-1">取消</button>
                                <button id="save-solution-entry-button" class="action-button bg-blue-500 hover:bg-blue-600 text-xs py-1 px-2">儲存此方案</button>
                            </div>
                        </div>

                        <div class="items-center px-4 py-3 mt-2 text-right border-t">
                            <button id="close-triz-modal-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">關閉</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ideality-assessment-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                <div class="modal-content mx-auto p-5 border w-11/12 md:w-3/5 lg:w-1/2 shadow-lg rounded-md bg-white">
                    <button class="modal-close-button" data-modal-id="ideality-assessment-modal">&times;</button>
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">TRIZ 理想性評估</h3>
                        <p id="ideality-modal-solution-text" class="text-sm text-gray-600 my-2 text-center"></p>
                        <input type="hidden" id="assessing-solution-contradiction-node-id">
                        <input type="hidden" id="assessing-solution-entry-id">

                        <div id="ideality-criteria-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
                            </div>

                        <div class="text-center my-3">
                            <span class="text-md font-semibold">理想性加權總分: </span>
                            <span id="ideality-total-score-display" class="text-lg font-bold text-blue-600">0.00</span>
                             <p class="text-xs text-gray-500 mt-1">(權重總和建議為1，分數範圍0-10)</p>
                             <p id="ideality-weights-sum-warning" class="text-xs text-red-500 mt-1" style="display:none;">注意：目前權重總和不為 1。請調整權重以確保總和為 1。</p>
                        </div>

                        <div class="items-center px-4 py-3 mt-4 text-right border-t">
                            <button id="reset-ideality-weights-button" class="action-button mr-2 px-4 py-2 bg-gray-400 text-gray-800 rounded-md hover:bg-gray-500">重設權重</button>
                            <button id="cancel-ideality-assessment-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                            <button id="save-ideality-assessment-button" class="action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">儲存評估</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                 <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                    <button class="modal-close-button" data-modal-id="and-source-modal">&times;</button>
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">設定 AND 輸入源</h3>
                        <p id="and-source-modal-node-text" class="text-sm text-gray-600 my-2 text-center"></p>
                        <div id="and-source-options-container" class="modal-options-container my-4">
                            </div>
                        <div class="items-center px-4 py-3 mt-4 text-right border-t">
                            <button id="cancel-and-sources-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                            <button id="save-and-sources-button" class="action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">儲存設定</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                 <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                    <button class="modal-close-button" data-modal-id="effect-parameter-modal">&times;</button>
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">設定效果參數</h3>
                        <p id="effect-parameter-modal-node-text" class="text-sm text-gray-600 my-2 text-center"></p>
                        <div id="effect-parameter-options-container" class="modal-options-container my-4">
                            </div>
                        <div class="items-center px-4 py-3 mt-4 text-right border-t">
                            <button id="cancel-effect-parameters-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                            <button id="save-effect-parameters-button" class="action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">儲存設定</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
                <div class="modal-content mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                    <button class="modal-close-button" data-modal-id="settings-modal">&times;</button>
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">工具設定</h3>

                        <div class="mt-4">
                            <h4 class="text-md font-semibold text-gray-800 mb-2">自訂理想性評估準則</h4>
                            <p class="text-sm text-gray-600 mb-3">在這裡管理您的自訂理想性評估準則。這些準則將用於所有解決方案的理想性評估。</p>

                            <div id="custom-criteria-list" class="max-h-60 overflow-y-auto border rounded-md p-2 bg-gray-50">
                                </div>

                            <button id="add-new-criterion-button" class="action-button bg-green-500 hover:bg-green-600 text-sm py-1 px-2 mt-3">
                                <i class="fas fa-plus mr-1"></i> 新增評估準則
                            </button>

                            <div id="edit-criterion-form" class="criterion-form" style="display:none;">
                                <h5 id="criterion-form-title" class="text-sm font-semibold text-gray-700 mb-2"></h5>
                                <input type="hidden" id="editing-criterion-id">
                                <label for="criterion-name-input">準則名稱:</label>
                                <input type="text" id="criterion-name-input" placeholder="例如: 顧客滿意度">
                                <label for="criterion-default-score-input">預設分數 (0-10):</label>
                                <input type="number" id="criterion-default-score-input" min="0" max="10" value="5">
                                <label for="criterion-default-weight-input">預設權重 (0-1):</label>
                                <input type="number" id="criterion-default-weight-input" step="0.01" min="0" max="1" value="0.25">
                                <label for="criterion-description-input">準則說明 (用於提示):</label>
                                <textarea id="criterion-description-input" rows="3" placeholder="詳細說明此準則的意義和評分標準"></textarea>
                                <div class="text-right">
                                    <button id="cancel-criterion-edit-button" class="action-button bg-gray-400 hover:bg-gray-500 text-xs py-1 px-2 mr-1">取消</button>
                                    <button id="save-criterion-button" class="action-button bg-blue-500 hover:bg-blue-600 text-xs py-1 px-2">儲存準則</button>
                                </div>
                            </div>
                        </div>

                        <div class="items-center px-4 py-3 mt-4 text-right border-t">
                            <button id="close-settings-modal-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">關閉</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        // --- 1. Constants.js ---
        const Constants = {
            ZOOM_STEP: 0.1,
            MIN_ZOOM: 0.2,
            MAX_ZOOM: 3.0,
            MAX_HISTORY_STATES: 50,
            QUADRANT_COLORS: {
                Q1: 'rgba(220, 252, 231, 0.4)', Q2: 'rgba(219, 234, 254, 0.4)',
                Q3: 'rgba(254, 226, 226, 0.4)', Q4: 'rgba(254, 249, 195, 0.4)',
            },
            QUADRANT_LABELS: {
                Q1: '長期規劃 (Q1)', Q2: '優先方案 (Q2)',
                Q3: '不值得考慮 (Q3)', Q4: '不應執行 (Q4)'
            },
            ABC_POINT_STYLES: { 'A': 'rectRot', 'B': 'triangle', 'C': 'star', 'none': 'circle' },
            ABC_COLORS: {
                'A': 'rgba(239, 68, 68, 0.8)', 'B': 'rgba(249, 115, 22, 0.8)',
                'C': 'rgba(245, 158, 11, 0.8)', 'none': 'rgba(107, 114, 128, 0.7)'
            },
            ABC_BORDER_COLORS: {
                'A': 'rgba(220, 38, 38, 1)', 'B': 'rgba(234, 88, 12, 1)',
                'C': 'rgba(217, 119, 6, 1)', 'none': 'rgba(75, 85, 99, 1)'
            },
            EFFECT_PARAMETERS: {
                "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
                "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
                "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
            },
            DEFAULT_IDEALITY_CRITERIA: [
                { id: 'crit-1', name: '問題是否完全解決？', defaultScore: 5, defaultWeight: 0.15, description: '此方案解決問題的程度。\n0 分：完全沒有解決問題。\n5 分：部分解決問題，但仍有明顯缺陷或遺留問題。\n10 分：完美解決所有問題，無任何遺留或副作用。' },
                { id: 'crit-2', name: '是否為雙贏局面？', defaultScore: 5, defaultWeight: 0.15, description: '此方案是否能為所有相關方（如顧客、員工、公司、環境）帶來正面效益，避免零和遊戲。\n0 分：對某些方有害，或只有一方受益。\n5 分：各方利益平衡，但無顯著增益。\n10 分：所有相關方皆能顯著受益，達到共贏。' },
                { id: 'crit-3', name: '有無產生負面效應？', defaultScore: 5, defaultWeight: 0.15, description: '此方案是否會產生新的負面效果或惡化現有問題。\n0 分：產生許多新的負面效果，或使現有問題更糟。\n5 分：產生輕微負面效果，或對現有問題無影響。\n10 分：完全沒有產生任何負面效果。' },
                { id: 'crit-4', name: '多符合理想性 (低成本/資源)？', defaultScore: 5, defaultWeight: 0.15, description: '此方案是否能以最低的成本、時間、人力、資源等達成目標。\n0 分：需要極高的成本和資源投入。\n5 分：成本和資源投入適中。\n10 分：幾乎不需額外成本或資源，利用現有條件達成。' },
                { id: 'crit-5', name: '創新性/獨特性', defaultScore: 5, defaultWeight: 0.20, description: '此方案是否具有創新性或獨特性？\n0 分：缺乏新意，為常見方案。\n5 分：有一定新意，但非突破性。\n10 分：極具創新性，獨一無二，可能開創新的領域。' },
                { id: 'crit-6', name: '實施難度/可行性', defaultScore: 5, defaultWeight: 0.20, description: '此方案的實施難度與可行性。\n0 分：實施極其困難，幾乎不可行。\n5 分：實施有一定難度，但可行。\n10 分：實施簡單，資源易得，高度可行。' }
            ]
        };

        // --- 2. Utils.js ---
        const Utils = {
            deepCopy: (obj) => JSON.parse(JSON.stringify(obj)),

            /**
             * 填充下拉選單。
             * @param {HTMLElement} selectElement - 要填充的 select 元素。
             * @param {Array<string>} optionsArray - 包含選項文字的陣列。
             * @param {boolean} includeDefault - 是否包含「未選擇」選項。
             */
            populateSelect: (selectElement, optionsArray, includeDefault = true) => {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                if (includeDefault) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "未選擇";
                    selectElement.appendChild(defaultOption);
                }
                optionsArray.forEach(optionText => {
                    if (includeDefault && optionText === "未選擇" && optionsArray.indexOf("未選擇") !== 0) return;
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                });
            },

            /**
             * 建立一個帶有樣式和事件監聽器的按鈕。
             * @param {string} text - 按鈕上顯示的文字。
             * @param {string} className - 要添加到按鈕的 CSS 類名。
             * @param {function} onClickHandler - 按鈕點擊時執行的函式。
             * @returns {HTMLButtonElement} 建立的按鈕元素。
             */
            createActionButton: (text, className, onClickHandler) => {
                const button = document.createElement('button');
                button.classList.add('action-button', ...className.split(' '));
                button.textContent = text;
                button.addEventListener('click', onClickHandler);
                return button;
            },

            calculateWeightedScore: (criteriaArray) => {
                let totalWeightedScore = 0;
                criteriaArray.forEach(crit => {
                    totalWeightedScore += crit.score * crit.weight;
                });
                return totalWeightedScore;
            },

            getDefaultIdealityAssessment: (customIdealityCriteria) => {
                const assessment = { criteria: [], weightedScore: null };
                customIdealityCriteria.forEach(crit => {
                    assessment.criteria.push({ id: crit.id, name: crit.name, score: crit.defaultScore, weight: crit.defaultWeight, description: crit.description });
                });
                return assessment;
            }
        };

        // --- 3. TrizMatrix.js ---
        class TrizMatrix {
            #parameters = [
                "活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性",
                "活動方便性", "活動安全性", "活動可靠性", "系統有效性", "系統可變性",
                "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性",
                "系統可靠性", "內部風險", "外部風險", "信息共享", "信息損失",
                "信息流", "回饋", "物料流", "對系統的有害影響", "系統產生的有害影響",
                "環境穩定性", "顧客穩定性", "顧客壓力", "組織穩定性", "組織壓力",
                "適應性/多功能性"
            ];
            #inventivePrinciplesNames = [
                "分割 (Segmentation)", "取出/分離 (Taking out/Separation)", "改變局部特性 (Local quality)", "非對稱性 (Asymmetry)", "合併/整合 (Merging/Consolidation)",
                "多用性/多功能 (Universality/Multi-functionality)", "套疊/巢狀結構 (Nesting/Nested doll)", "反制行動 (Anti-weight/Counteraction)", "預先反制行動 (Preliminary anti-action/Prior counteraction)", "預先行動 (Preliminary action/Prior action)",
                "事先補償/預防 (Cushion in advance/Prior compensation)", "消除緊張 (Equipotentiality/Remove stress)", "另一方向/反向操作 (Do it in reverse/The other way around)", "非直線性 (Spheroidality/Non-linearity)", "動態化 (Dynamics/Dynamization)",
                "稍微少些或多些(的動作) (Partial or excessive actions/Slightly less or more)", "另外維度/空間 (Another dimension/New dimension)", "共鳴(協調) (Mechanical vibration/Resonance)", "週期行動 (Periodic action)", "連續的有利作用 (Continuity of useful action)",
                "快速行動 (Skipping/Rushing through)", "轉有害為有利 (Blessing in disguise/Convert harm into benefit)", "回饋 (Feedback)", "中介物/媒介 (Intermediary/Mediator)", "自助/自我服務 (Self-service)",
                "使用複製品或模型 (Copying/Use copies or models)", "廉價與短期[拋棄式] (Cheap short-living objects/Dispose)", "替換系統運作原理/使用其他原理 (Replacing mechanical system/Use another principle)", "流動性和靈活性 (Pneumatics and hydraulics/Fluidity and flexibility)", "改變邊界條件 (Flexible shells and thin films/Thin films and flexible shells)",
                "孔洞和網路 (Porous materials/Holes and networks)", "改變外觀/可見度 (Color changes/Change appearance or visibility)", "同質性 (Homogeneity)", "丟棄與恢復 (Discarding and recovering/Rejecting and regenerating parts)", "改變特性 (Parameter changes/Change properties)",
                "模範轉移 (Phase transitions/Paradigm Shift)", "相對變化 (Thermal Expansion/Relative Change)", "增強的環境 (Enriched Atmosphere/Enhanced Environment)", "鈍性(惰性)環境 (Inert Atmosphere/Inert Environment)", "組合(複合)結構 (Composite Materials/Composite Structures)"
            ];
            #matrixData = [
                // 原始數據，但每個字串會被解析為數字陣列
                ["X","26,3,40,2","18,35,28,26","39,8,39,36","33,18,17,7","21,12,6,30","38,39,18,3","36,18,21,3","32,11,5,11","12,16,23,2","18,23,15,38","26,25,21,19","39,22,2,33","38,24,3,6,28","16,17,28,8","38,6,4,21","17,29,15,14","11,30,8,5","19,22,29,33,11","29,10,16,19,3","16,26,21,3","4,21,11,24","4,40,10,15","5,2,16,26","39,21,40,27","11,39,15,36","23,16,22","14,4,28,40","34,25,16,3","18,8,40,22","33,40,19,3"],
                ["3,35,40,2","X","7,39,20","21,39,35,26","18,35,1,40","9,27,26,21,25","1,2,24,22","12,5,6,30","24,19,26,3","17,7,19,39","21,13,20,35","27,2,5,13","30,4,24,20","18,9,28,1","28,26,2,15","2,15,39,8","21,12,20,40","16,38,10,12","13,19,37,11","9,31,29,7","18,24,36,33,18","38,39,17,37","39,18,1,2,23,14","38,28,36,39","25,20,24,27","2,27,19,5","26,27,1,17","32,12,33,11","32,13,23,4,19","2,35,26,37","35,16,34,11"],
                ["18,35,28,26","7,39,20","X","40,9,27,26","21,12,6,30","19,15,30,29","36,24,27,29","24,22,8,16","39,40,25,30","8,16,26,9","38,33,17,29","31,33,28,10","34,1,5,36","25,23,37,8","30,12,22,40,35","32,11,10,16,17","28,8,38,6","4,21,17,29","38,15,14","11,30,8,5","19,22,29,33,11","29,10,16,19,3","16,26,21,3","4,21,11,24","4,40,10,15","5,2,16,26","39,21,40,27","11,39,15,36","23,16,22","14,4,28,40","34,25,16,3"],
                ["39,8,39,36","21,39,35,26","40,9,27,26","X","24,19,26,3","17,7,19,39","21,13,20,35","27,2,5,13","30,4,24,20","18,9,28,1","28,26,2,15","2,15,39,8","21,12,20,40","16,38,10,12","13,19,37,11","9,31,29,7","18,24,36,33,18","38,39,17,37","39,18,1,2,23,14","38,28,36,39","25,20,24,27","2,27,19,5","26,27,1,17","32,12,33,11","32,13,23,4,19","2,35,26,37","35,16,13,10","17,15,32,18,14,37","26,4,30,9","31,25,4,19,15","27,2"],
                ["33,18,17,7","18,35,1,40","21,12,6,30","24,19,26,3","X","35,20,23,5","36,24,30,29","19,15,40,39","38,40,16,5","36,33,25,26","23,18,33,6","27,38,2,4","19,4,28,11","8,21,36,5","32,10,22,36","26,27,18,21","26,21,30,22","40,23,39,17","9,1,8,39,17","33,37,9,35,19","28,15,24,27","15,19,13,15,31","1,26,11,32","38,39,25,27","24,21,8,34,18","29,11,30,2","31,32,11,4,5","7,1,8,16","5,34,2,40","26,2,3,29","30,8,30,5"],
                ["21,12,6,30","9,27,26,21,25","19,15,30,29","17,7,19,39","35,20,23,5","X","24,22,8,16","39,40,25,30","8,16,26,9","38,33,17,29","31,33,28,10","34,1,5,36","25,23,37,8","30,12,22,40,35","32,11,10,16,17","28,8,38,6","4,21,17,29","38,15,14","11,30,8,5","19,22,29,33,11","29,10,16,19,3","16,26,21,3","4,21,11,24","4,40,10,15","5,2,16,26","39,21,40,27","11,39,15,36","23,16,22","14,4,28,40","34,25,16,3","18,8,40,22"],
                ["38,39,18,3","1,2,24,22","36,24,27,29","21,13,20,35","36,24,30,29","24,22,8,16","X","18,35,28,26","39,8,39,36","33,18,17,7","21,12,6,30","38,39,18,3","36,18,21,3","32,11,5,11","12,16,23,2","18,23,15,38","26,25,21,19","39,22,2,33","38,24,3,6,28","16,17,28,8","38,6,4,21","17,29,15,14","11,30,8,5","19,22,29,33,11","29,10,16,19,3","16,26,21,3","4,21,11,24","4,40,10,15","5,2,16,26","39,21,40,27","11,39,15,36"],
                ["36,18,21,3","12,5,6,30","24,22,8,16","27,2,5,13","19,15,40,39","39,40,25,30","18,35,28,26","X","24,19,26,3","17,7,19,39","21,13,20,35","27,2,5,13","30,4,24,20","18,9,28,1","28,26,2,15","2,15,39,8","21,12,20,40","16,38,10,12","13,19,37,11","9,31,29,7","18,24,36,33,18","38,39,17,37","39,18,1,2,23,14","38,28,36,39","25,20,24,27","2,27,19,5","26,27,1,17","32,12,33,11","32,13,23,4,19","2,35,26,37","35,16,34,11"],
                ["32,11,5,11","24,19,26,3","39,40,25,30","30,4,24,20","38,40,16,5","8,16,26,9","33,18,17,7","24,19,26,3","X","14,17,18,17","21,39,39,24","14,26,36,39","12,16,23,34","11,29,8,5","16,19,25,9","30,12,10,18,23","24,3,4,21","11,30,10,16","33,11,33,6","9,26,5,11","30,1,37,13","17,40,18,31","1,14,33,31","18,27,23,22","25,38,11,26,9","31,33,28,18","16,5,32,24","23,4,10,4","21,27,30,10","16,1,32,37","8,7,6,40"],
                ["12,16,23,2","17,7,19,39","8,16,26,9","18,9,28,1","36,33,25,26","38,33,17,29","21,12,6,30","17,7,19,39","14,17,18,17","X","36,7,23,34","17,29,23,22","25,38,11,14,17","18,17,21,39","17,40,39,24","14,26,36,39","12,16,23,34","11,29,8,5","16,19,25,9","30,12,10,18,23","24,3,4,21","11,30,10,16","33,11,33,6","9,26,5,11","30,1,37,13","17,40,18,31","1,14,33,31","18,27,23,22","25,38,11,26,9","31,33,28,18","16,5,32,24"],
                ["18,23,15,38","21,13,20,35","38,33,17,29","28,26,2,15","23,18,33,6","31,33,28,10","38,39,18,3","21,13,20,35","21,39,39,24","36,7,23,34","X","14,26,12,1","37,8,7,6,40","36,13,14,17","18,17,21,39","17,40,39,24","14,26,36,39","12,16,23,34","11,29,8,5","16,19,25,9","30,12,10,18,23","24,3,4,21","11,30,10,16","33,11,33,6","9,26,5,11","30,1,37,13","17,40,18,31","1,14,33,31","18,27,23,22","25,38,11,26,9","31,33,28,18"],
                ["26,25,21,19","27,2,5,13","34,1,5,36","2,15,39,8","27,38,2,4","34,1,5,36","36,18,21,3","27,2,5,13","14,26,36,39","17,29,23,22","14,26,12,1","X","32,18,8,35","2,23,14,17","18,17,21,39","17,40,39,24","14,26,36,39","12,16,23,34","11,29,8,5","16,19,25,9","30,12,10,18,23","24,3,4,21","11,30,10,16","33,11,33,6","9,26,5,11","30,1,37,13","17,40,18,31","1,14,33,31","18,27,23,22","25,38,11,26,9"],
                ["39,22,2,33","30,4,24,20","25,23,37,8","16,38,10,12","19,4,28,11","25,23,37,8","32,11,5,11","30,4,24,20","12,16,23,34","25,38,11,14,17","37,8,7,6,40","32,18,8,35","X","38,18,8,16","39,24,14,17","1,35,29,21","34,30,6,22","23,15,11,37,3","18,2,28,40","15,10,18,17","26,24,14,34,4","36,15,6,33,15","25,19,14,16","34,28,32,10","12,1,40,4","12,1,36,39","39,12,18,38","32,37,16,19","1,14,14,26","14,16,10,9,3","40,35,38,19"],
                ["38,24,3,6,28","18,9,28,1","30,12,22,40,35","13,19,37,11","8,21,36,5","30,12,22,40,35","12,16,23,2","18,9,28,1","11,29,8,5","16,19,25,9","36,13,14,17","2,23,14,17","38,18,8,16","X","26,1,37,3","21,7,30,26","38,14,33,19","8,35,35,21","8,5,3,34","21,5,37,33","24,17,21,38","31,10,40,24,25","33,19,34,5,3","1,33,8,38","39,4,40,2,16","16,1,24,25","18,24,19,5","34,35,28","32,6,29,36","37,12,18,24"],
                ["16,17,28,8","28,26,2,15","32,11,10,16,17","9,31,29,7","32,10,22,36","32,11,10,16,17","18,23,15,38","28,26,2,15","16,19,25,9","30,12,10,18,23","18,17,21,39","17,40,39,24","39,24,14,17","26,1,37,3","X","12,18,24,5,11","34,35,28,32,6","29,36,37,12,18,24","27,22,26,15","7,18,37,34,30","39,12,5,11","29,36,37,33,21","1,8,7,6,22","18,38,12,34","23,8,26,27","36,34,18,27","13,17,32,10","25,29,29","35,29,6,40","23,15,15,6","20,37,21,14","38,14,12,30"],
                ["38,6,4,21","2,15,39,8","28,8,38,6","18,24,36,33,18","26,27,18,21","28,8,38,6","26,25,21,19","2,15,39,8","30,12,10,18,23","24,3,4,21","17,40,39,24","14,26,36,39","1,35,29,21","21,7,30,26","12,18,24,5,11","X","10,3,15,25","37,12,36,12","9,4,1,2","36,10,30,29","16,17,30,27","24,4,23,32","8,39,18,10,23","16,12,26,31","38,32,5,8","19,20,33,8","8,33,19,10","30,29,25,23,22","35,34,9,38,20","23,20,38,27","26,11,28,14"],
                ["17,29,15,14","39,8,21,12","4,21,17,29","38,39,17,37","26,21,30,22","4,21,17,29","39,22,2,33","21,12,20,40","24,3,4,21","11,30,10,16","14,26,36,39","12,16,23,34","34,30,6,22","38,14,33,19","34,35,28,32,6","10,3,15,25","X","37,12,2,24","20,40,4,18,12","16,5,23,32","25,23,31,22","35,37,10,34","24,20,15,23","39,18,15,34","3,16,12,10,26","39,32,38,18,25","21,15,3,38","37,13,28,35,34","10,34,15,30","26,11,22,35","27,16,1,30"],
                ["11,30,8,5","20,40,16,38","38,15,14","39,18,1,2","40,23,39,17","38,15,14","38,24,3,6,28","16,38,10,12","11,30,10,16","33,11,33,6","12,16,23,34","11,29,8,5","23,15,11,37,3","8,35,35,21","29,36,37,12,18,24","37,12,36,12","37,12,2,24","X","9,4,1,2","36,10,30,29","16,17,30,27","24,4,23,32","8,39,18,10,23","16,12,26,31","38,32,5,8","19,20,33,8","8,33,19,10","30,29,25,23,22","35,34,9,38,20","23,20,38,27","26,11,28,14"],
                ["19,22,29,33,11","10,12,13,19","11,30,8,5","23,14,38,28","9,1,8,39,17","11,30,8,5","16,17,28,8","13,19,37,11","33,11,33,6","9,26,5,11","11,29,8,5","16,19,25,9","18,2,28,40","8,5,3,34","27,22,26,15","9,4,1,2","20,40,4,18,12","9,4,1,2","X","7,14,26,11","21,6,21,9","2,24,35,37","36,11,4,20","10,24,13,25","8,25,11,6","9,31,8,16","23,40,16,21","40,4,18,12","16,5,12,22","9,37,4,28","33,39,10,34"],
                ["29,10,16,19,3","37,11,9,31","19,22,29,33,11","36,39,25,20","33,37,9,35,19","19,22,29,33,11","38,6,4,21","9,31,29,7","9,26,5,11","30,1,37,13","16,19,25,9","30,12,10,18,23","15,10,18,17","21,5,37,33","7,18,37,34,30","36,10,30,29","16,5,23,32","36,10,30,29","7,14,26,11","X","10,34,10,34","23,22,35,34","9,38,20","23,20,38,27","26,7,32,10","14,19,3,12,28","10,3,15,25","37,12,36,12","9,4,1,2","36,10,30,29","16,17,30,27"],
                ["16,26,21,3","29,7,18,24","29,10,16,19,3","24,27,2,27","28,15,24,27","29,10,16,19,3","17,29,15,14","18,24,36,33,18","30,1,37,13","17,40,18,31","30,12,10,18,23","24,3,4,21","26,24,14,34,4","24,17,21,38","39,12,5,11","16,17,30,27","25,23,31,22","16,17,30,27","21,6,21,9","10,34,10,34","X","2,3,13,16","1,39,21,6","8,37,3,23","7,9,9,8,5","29,10,27,39","1,20,7,6","3,15,20,26","23,32,1,14,31","13,19,29,13","37,29,13,3"],
                ["4,21,11,24","36,33,18,39","16,26,21,3","19,5,26,27","15,19,13,15,31","16,26,21,3","11,30,8,5","38,39,17,37","17,40,18,31","1,14,33,31","24,3,4,21","11,30,10,16","36,15,6,33,15","31,10,40,24,25","29,36,37,33,21","24,4,23,32","35,37,10,34","24,4,23,32","2,24,35,37","23,22,35,34","2,3,13,16","X","36,12,1,15","19,16,8,13,32","14,36,8,2,3","2,3,13,3","37,24,35,10","15,11,20,12,32","19,31,25,32","30,3,34,25","33,24,7,35"],
                ["4,40,10,15","18,39,17,37","4,21,11,24","32,12,1,17","1,26,11,32","4,21,11,24","19,22,29,33,11","39,18,1,2","1,14,33,31","18,27,23,22","11,30,10,16","33,11,33,6","25,19,14,16","33,19,34,5,3","8,7,6,22","8,39,18,10,23","24,20,15,23","8,39,18,10,23","36,11,4,20","9,38,20","1,39,21,6","36,12,1,15","X","28,36,19,16","24,38,29,33","32,34,11,7","32,31,25,27","19,11,35,17","30,2,1,2,39,8","21,19,7,28","35,4,24,22"],
                ["5,2,16,26","23,14,38,28","4,40,10,15","33,11,32,13","38,39,25,27","4,40,10,15","29,10,16,19,3","23,14,38,28","18,27,23,22","25,38,11,26,9","33,11,33,6","9,26,5,11","34,28,32,10","1,33,8,38","18,38,12,34","16,12,26,31","39,18,15,34","16,12,26,31","10,24,13,25","23,20,38,27","8,37,3,23","19,16,8,13,32","28,36,19,16","X","35,30,9,27","33,6,24,22","38,20,37,7","37,23,35,37,29","10,16,34,5","37,14,26,38","28,10,4,16,38"],
                ["39,21,40,27","36,39,25,20","5,2,16,26","2,35,26,37","24,21,8,34,18","5,2,16,26","16,26,21,3","25,20,24,27","25,38,11,26,9","31,33,28,18","9,26,5,11","30,1,37,13","12,1,40,4","39,4,40,2,16","23,8,26,27","38,32,5,8","3,16,12,10,26","38,32,5,8","8,25,11,6","26,7,32,10","7,9,9,8,5","14,36,8,2,3","24,38,29,33","35,30,9,27","X","37,7,11,40","5,1,29,6,39","3,7,34,40,28,33","2,35,10,13","4,33,25,38","39,8,19,11"],
                ["11,39,15,36","24,22,8,16","39,21,40,27","35,16,34,11","29,11,30,2,31","39,21,40,27","4,21,11,24","2,27,19,5","31,33,28,18","16,5,32,24","30,1,37,13","17,40,18,31","12,1,36,39","16,1,24,25","36,34,18,27","19,20,33,8","39,32,38,18,25","19,20,33,8","9,31,8,16","14,19,3,12,28","29,10,27,39","2,3,13,3","32,34,11,7","24,22,38,20","37,7,11,40","X","39,19,9,2,35","10,13,40,18","38,7,2,16","16,15,10,24,19","2,5,30,15,14"],
                ["23,16,22","8,16,26,9","11,39,15,36","13,10,17,15","32,11,4,5","11,39,15,36","4,40,10,15","26,27,1,17","16,5,32,24","23,4,10,4","17,40,18,31","1,14,33,31","39,12,18,38","18,24,19,5","13,17,32,10","8,33,19,10","8,33,19,10","23,40,16,21","37,12,36,12","10,3,15,25","1,20,7,6","37,24,35,10","32,31,25,27","37,23,35,37,29","5,1,29,6,39","39,19,9,2,35","X","13,32,17,38","17,30,5,1","4,38,14,6","22,18,30,10,9,1"],
                ["14,4,28,40","38,33,17,29","23,16,22","32,18,14,37","7,1,8,16","23,16,22","5,2,16,26","32,12,33,11","23,4,10,4","21,27,30,10","1,14,33,31","18,27,23,22","32,37,16,19","34,35,28","25,29,29","30,29,25,23,22","25,29,29","40,4,18,12","16,5,12,22","37,12,36,12","3,15,20,26","15,11,20,12,32","19,11,35,17","10,16,34,5","6,39,3,7","10,13,40,18","13,32,17,38","X","9,28,15,17,40","29,21,5,1","23,10,9,38,1,37"],
                ["34,25,16,3","31,33,28,10","14,4,28,40","26,4,30,9","5,34,2,40","14,4,28,40","39,21,40,27","32,13,23,4,19","21,27,30,10","16,1,32,37","18,27,23,22","25,38,11,26,9","1,14,14,26","32,6,29,36","35,29,6,40","35,34,9,38,20","35,34,9,38,20","16,15,10","9,37,4,28","9,4,1,2","23,32,1,14,31","30,3,34,25","30,2,1,2,39,8","21,19,7,28","34,40,28,33","38,7,2,16","17,30,5,1","9,28,15,17,40","X","14,10,29,21","40,3,18,37,32,34"],
                ["18,8,40,22","34,1,5,36","34,25,16,3","31,25,4,19,15","26,2,3,29","34,25,16,3","11,39,15,36","2,35,26,37","16,1,32,37","8,7,6,40","25,38,11,26,9","31,33,28,18","14,16,10,9,3","37,12,18,24","23,15,15,6","23,20,38,27","23,20,38,27","24,19,2,5","33,39,10,34","36,10,30,29","13,19,29,13","33,24,7,35","35,17,30,2","37,14,26,38","2,35,10,13","16,15,10","4,38,14,6","29,21,5,1","14,10,29,21","X","32,2,17,40,22,18"],
                ["33,40,19,3","25,23,37,8","18,8,40,22","19,15,27,2","30,8,30,5","18,8,40,22","23,16,22","35,16,34,11","8,7,6,40","36,13,14,17","31,33,28,18","16,5,32,24","40,35,38,19","12,18,24,5,11","20,37,21,14","26,11,22,35","26,11,22,35","24,19,2,5","26,11,22,35","16,17,30,27","37,29,13,3","7,35,9,27","11,7,2,35","35,30,32,34","24,38,29,33","4,33,25,38","22,18,30,10","23,10,9,38","40,3,18,37","32,2,17,40","X"]
            ].map(row => row.map(cell => cell === "X" ? [] : cell.split(',').map(Number)));

            getParameters() { return [...this.#parameters]; }
            getInventivePrinciplesNames() { return [...this.#inventivePrinciplesNames]; }
            getPrincipleName(principleNumber) {
                if (principleNumber >= 1 && principleNumber <= this.#inventivePrinciplesNames.length) {
                    return this.#inventivePrinciplesNames[principleNumber - 1];
                }
                console.warn(`無效的發明原理編號: ${principleNumber}`);
                return null;
            }
            getRecommendedPrinciples(improvingParameterIndex, worseningParameterIndex) {
                if (improvingParameterIndex < 0 || improvingParameterIndex >= this.#parameters.length ||
                    worseningParameterIndex < 0 || worseningParameterIndex >= this.#parameters.length) {
                    console.error("無效的參數索引。請確保索引在0到30之間。");
                    return [];
                }
                const principlesNumbers = this.#matrixData[improvingParameterIndex][worseningParameterIndex];
                return principlesNumbers ? principlesNumbers.map(num => this.getPrincipleName(num)).filter(name => name !== null) : [];
            }
            getRecommendedPrinciplesByName(improvingParameterName, worseningParameterName) {
                const improvingIndex = this.#parameters.indexOf(improvingParameterName);
                const worseningIndex = this.#parameters.indexOf(worseningParameterName);
                if (improvingIndex === -1) { console.error(`改善參數名稱無效: ${improvingParameterName}`); return []; }
                if (worseningIndex === -1) { console.error(`惡化參數名稱無效: ${worseningParameterName}`); return []; }
                return this.getRecommendedPrinciples(improvingIndex, worseningIndex);
            }
        }
        const trizMatrix = new TrizMatrix();

        // --- 4. StateStore.js ---
        const StateStore = (function() {
            let state = {
                rcaData: null,
                nodeIdCounter: 0,
                currentZoom: 1.0,
                history: [],
                historyIndex: -1,
                isFinalizedView: false,
                // currentAbcCauseFilter: 'all', // 移除原因ABC篩選
                currentAbcSolutionFilter: 'all',
                customIdealityCriteria: [],
                criterionIdCounter: 0,
                currentAndTargetNodeId: null, // For AND source modal
                currentParameterTargetNodeId: null, // For Effect Parameter modal
                currentTrizContradictionNodeId: null, // For TRIZ solution modal
                currentAssessingSolution: { contradictionNodeId: null, solutionId: null } // For Ideality Assessment modal
            };

            const listeners = [];

            function subscribe(listener) {
                listeners.push(listener);
                return () => {
                    listeners = listeners.filter(l => l !== listener);
                };
            }

            function notifyListeners() {
                listeners.forEach(listener => listener(Utils.deepCopy(state)));
            }

            function getState() {
                return Utils.deepCopy(state);
            }

            function setState(newStatePartial, { pushToHistory = true, notify = true } = {}) {
                const oldState = Utils.deepCopy(state);
                state = { ...state, ...newStatePartial };

                // Handle history push logic here, ensuring it's only for significant changes
                // HistoryManager will call pushState explicitly for undo/redo points
                if (pushToHistory && JSON.stringify(oldState.rcaData) !== JSON.stringify(state.rcaData)) {
                    // Only push if rcaData actually changed
                    HistoryManager.pushState(Utils.deepCopy(state));
                }

                if (notify) {
                    notifyListeners();
                }
            }

            function initializeDefaultCriteria() {
                state.customIdealityCriteria = Utils.deepCopy(Constants.DEFAULT_IDEALITY_CRITERIA);
                let maxCritId = 0;
                state.customIdealityCriteria.forEach(crit => {
                    const idNum = parseInt(crit.id.replace('crit-', ''));
                    if (!isNaN(idNum) && idNum > maxCritId) { maxCritId = idNum; }
                });
                state.criterionIdCounter = maxCritId;
            }

            function restoreState(restoredState) {
                state = Utils.deepCopy(restoredState);
                notifyListeners();
            }

            return {
                getState,
                setState,
                subscribe,
                initializeDefaultCriteria,
                restoreState
            };
        })();

        // --- 5. RcaProcessor.js ---
        const RcaProcessor = (function() {

            /**
             * 遞迴地在 RCA 數據結構中按 ID 查找節點。
             * @param {object} node - 當前要檢查的節點。
             * @param {string} id - 要查找的節點 ID。
             * @returns {object|null} 找到的節點對象，如果未找到則為 null。
             */
            function findNodeById(node, id) {
                if (!node || typeof node !== 'object') return null;
                if (node.id === id) return node;
                if (node.children && Array.isArray(node.children)) {
                    for (const child of node.children) {
                        if(!child) continue;
                        const found = findNodeById(child, id);
                        if (found) return found;
                    }
                }
                return null;
            }

            /**
             * 檢查節點的直接子節點是否同時包含正面效果和負面效果。
             * @param {object} nodeData - 要檢查的節點數據。
             * @returns {{hasPositiveChild: boolean, hasNegativeChild: boolean}} 包含檢查結果的對象。
             */
            function checkChildrenEffects(nodeData) {
                let hasPositiveChild = false;
                let hasNegativeChild = false;
                if (nodeData.children && Array.isArray(nodeData.children)) {
                    for (const child of nodeData.children) {
                        if(!child) continue;
                        if (child.type === 'positive-effect') hasPositiveChild = true;
                        if (child.type === 'negative-effect') hasNegativeChild = true;
                        if (hasPositiveChild && hasNegativeChild) break;
                    }
                }
                return { hasPositiveChild, hasNegativeChild };
            }

            /**
             * 建立一個新的節點數據對象。
             * @param {string} text - 節點的文字內容。
             * @param {string} type - 節點類型 ('initial-problem', 'cause', 'positive-effect', 'negative-effect')。
             * @param {string|null} parentId - 父節點的 ID，如果沒有父節點則為 null。
             * @param {boolean} isNonChangeable - (僅限原因節點) 是否為不可變更的原因。
             * @returns {object} 新建立的節點數據對象。
             */
            function createNodeData(text, type, parentId, isNonChangeable = false) {
                const state = StateStore.getState();
                const newNodeIdCounter = state.nodeIdCounter + 1;
                const node = {
                    id: `node-${newNodeIdCounter}`, text: text, type: type, parentId: parentId,
                    children: [], andSourceNodeIds: [], effectParameters: [],
                    improvingParameter: null, worseningParameter: null, solutionsGenerated: [],
                    // abcCategory: null, // 移除原因ABC篩選
                    // connectorLabelToParent: "" // 移除連接線標籤
                };
                if (type === 'cause') node.isNonChangeable = isNonChangeable;
                StateStore.setState({ nodeIdCounter: newNodeIdCounter }, { pushToHistory: false }); // Update counter, but don't push history for just counter change
                return node;
            }

            function setInitialProblem(problemText) {
                if (!problemText) { alert('請輸入主要負面效果！'); return; }
                const newNode = createNodeData(problemText, 'initial-problem', null);
                StateStore.setState({
                    rcaData: newNode,
                    nodeIdCounter: 1, // Reset counter for new diagram
                    // currentAbcCauseFilter: 'all', // 移除原因ABC篩選
                    currentAbcSolutionFilter: 'all',
                    currentZoom: 1.0,
                    isFinalizedView: false
                });
            }

            function addNode(parentId, nodeText, nodeType) { // 移除 connectorLabel 參數
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const parentNode = findNodeById(rcaDataCopy, parentId);
                if (parentNode) {
                    const newNode = createNodeData(nodeText, nodeType, parentId);
                    // newNode.connectorLabelToParent = connectorLabel; // 移除連接線標籤
                    parentNode.children.push(newNode);
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            function updateNodeTextAndConnectorLabel(nodeId, newText) { // 移除 newConnectorLabel 參數
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const nodeToEdit = findNodeById(rcaDataCopy, nodeId);
                if (nodeToEdit) {
                    nodeToEdit.text = newText;
                    // if (nodeToEdit.parentId) { // 移除連接線標籤
                    //     nodeToEdit.connectorLabelToParent = newConnectorLabel;
                    // }
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            function removeNode(nodeIdToRemove) {
                const state = StateStore.getState();
                let rcaDataCopy = Utils.deepCopy(state.rcaData);

                if (rcaDataCopy && rcaDataCopy.id === nodeIdToRemove) { alert('不能移除主要問題根源節點！'); return; }

                let nodeRemoved = false;

                function filterRecursive(node, idToRemove) {
                    if (!node) return null;
                    if (node.id === idToRemove) {
                        nodeRemoved = true;
                        function removeAndSourceFromEntireTree(currentNodeData, removedId) {
                            if (!currentNodeData) return;
                            if (currentNodeData.andSourceNodeIds && currentNodeData.andSourceNodeIds.includes(removedId)) {
                                currentNodeData.andSourceNodeIds = currentNodeData.andSourceNodeIds.filter(srcId => srcId !== removedId);
                            }
                            if (currentNodeData.children && Array.isArray(currentNodeData.children)) {
                                currentNodeData.children.forEach(child => removeAndSourceFromEntireTree(child, removedId));
                            }
                        }
                        removeAndSourceFromEntireTree(rcaDataCopy, idToRemove);
                        return null;
                    }
                    if (node.children && Array.isArray(node.children)) {
                        node.children = node.children.map(child => filterRecursive(child, idToRemove)).filter(child => child !== null);
                    }
                    return node;
                }

                rcaDataCopy = filterRecursive(rcaDataCopy, nodeIdToRemove);

                if (nodeRemoved) {
                    if (!rcaDataCopy) { // If all nodes are removed
                        StateStore.setState({
                            rcaData: null,
                            nodeIdCounter: 0,
                            history: [],
                            historyIndex: -1,
                            currentZoom: 1.0,
                            // currentAbcCauseFilter: 'all', // 移除原因ABC篩選
                            currentAbcSolutionFilter: 'all'
                        });
                    } else {
                        StateStore.setState({ rcaData: rcaDataCopy });
                    }
                }
            }

            function toggleNonChangeable(nodeId) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const node = findNodeById(rcaDataCopy, nodeId);
                if (node && node.type === 'cause') {
                    node.isNonChangeable = !node.isNonChangeable;
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            // function setAbcCategory(nodeId, category) { // 移除此功能
            //     const state = StateStore.getState();
            //     const rcaDataCopy = Utils.deepCopy(state.rcaData);
            //     const node = findNodeById(rcaDataCopy, nodeId);
            //     if (node && node.type === 'cause') {
            //         node.abcCategory = category;
            //         StateStore.setState({ rcaData: rcaDataCopy });
            //     }
            // }

            function setAndSources(targetNodeId, selectedSources) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const targetNode = findNodeById(rcaDataCopy, targetNodeId);
                if (targetNode) {
                    targetNode.andSourceNodeIds = selectedSources;
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            function setEffectParameters(targetNodeId, selectedParams) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const targetNode = findNodeById(rcaDataCopy, targetNodeId);
                if (targetNode) {
                    targetNode.effectParameters = selectedParams;
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            function setTrizParameters(contradictionNodeId, improvingParam, worseningParam) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const contradictionNode = findNodeById(rcaDataCopy, contradictionNodeId);
                if (contradictionNode) {
                    contradictionNode.improvingParameter = improvingParam === "未選擇" ? null : improvingParam;
                    contradictionNode.worseningParameter = worseningParam === "未選擇" ? null : worseningParam;
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            function addOrUpdateSolutionEntry(contradictionNodeId, solutionId, principle, description, timeRequired, cost) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const contradictionNode = findNodeById(rcaDataCopy, contradictionNodeId);

                if (!contradictionNode) return;

                if (!contradictionNode.solutionsGenerated) contradictionNode.solutionsGenerated = [];

                if (solutionId) {
                    const solIndex = contradictionNode.solutionsGenerated.findIndex(s => s.id === solutionId);
                    if (solIndex > -1) {
                        const sol = contradictionNode.solutionsGenerated[solIndex];
                        sol.principleName = principle;
                        sol.description = description;
                        sol.timeRequired = timeRequired;
                        sol.cost = cost;
                        if (!sol.idealityAssessment || !Array.isArray(sol.idealityAssessment.criteria)) {
                            sol.idealityAssessment = Utils.getDefaultIdealityAssessment(state.customIdealityCriteria);
                            sol.mcdmScore = Utils.calculateWeightedScore(sol.idealityAssessment.criteria);
                        }
                    }
                } else {
                    contradictionNode.solutionsGenerated.push({
                        id: `sol-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                        principleName: principle, description: description, abcCategory: null,
                        timeRequired: timeRequired, mcdmScore: null, cost: cost,
                        idealityAssessment: Utils.getDefaultIdealityAssessment(state.customIdealityCriteria)
                    });
                }
                StateStore.setState({ rcaData: rcaDataCopy });
            }

            function removeSolutionEntry(contradictionNodeId, solutionId) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const contradictionNode = findNodeById(rcaDataCopy, contradictionNodeId);
                if (contradictionNode && contradictionNode.solutionsGenerated) {
                    contradictionNode.solutionsGenerated = contradictionNode.solutionsGenerated.filter(s => s.id !== solutionId);
                    StateStore.setState({ rcaData: rcaDataCopy });
                }
            }

            function updateSolutionAbcCategory(contradictionNodeId, solutionId, newAbcCategory) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const contradictionNode = findNodeById(rcaDataCopy, contradictionNodeId);
                if (contradictionNode && contradictionNode.solutionsGenerated) {
                    const solution = contradictionNode.solutionsGenerated.find(s => s.id === solutionId);
                    if (solution) {
                        solution.abcCategory = newAbcCategory;
                        StateStore.setState({ rcaData: rcaDataCopy });
                    }
                }
            }

            function updateSolutionIdealityAssessment(contradictionNodeId, solutionId, updatedCriteria) {
                const state = StateStore.getState();
                const rcaDataCopy = Utils.deepCopy(state.rcaData);
                const contradictionNode = findNodeById(rcaDataCopy, contradictionNodeId);
                if (contradictionNode && contradictionNode.solutionsGenerated) {
                    const solution = contradictionNode.solutionsGenerated.find(s => s.id === solutionId);
                    if (solution) {
                        solution.idealityAssessment.criteria = updatedCriteria;
                        solution.idealityAssessment.weightedScore = Utils.calculateWeightedScore(updatedCriteria);
                        solution.mcdmScore = solution.idealityAssessment.weightedScore;
                        StateStore.setState({ rcaData: rcaDataCopy });
                    }
                }
            }

            function addOrUpdateCriterion(criterionId, name, defaultScore, defaultWeight, description) {
                const state = StateStore.getState();
                const criteriaCopy = Utils.deepCopy(state.customIdealityCriteria);
                let newCriterionIdCounter = state.criterionIdCounter;

                if (criterionId) {
                    const index = criteriaCopy.findIndex(c => c.id === criterionId);
                    if (index > -1) { criteriaCopy[index] = { id: criterionId, name, defaultScore, defaultWeight, description }; }
                } else {
                    newCriterionIdCounter++;
                    criteriaCopy.push({ id: `crit-${newCriterionIdCounter}`, name, defaultScore, defaultWeight, description });
                }
                StateStore.setState({ customIdealityCriteria: criteriaCopy, criterionIdCounter: newCriterionIdCounter });
            }

            function removeCriterion(criterionId) {
                const state = StateStore.getState();
                const criteriaCopy = Utils.deepCopy(state.customIdealityCriteria);
                if (criteriaCopy.length <= 1) { alert('至少需要一個評估準則！'); return; }
                // Use custom alert instead of confirm
                const confirmation = confirm('確定要移除此評估準則嗎？這將影響所有解決方案的理想性評估。');
                if (confirmation) {
                    const updatedCriteria = criteriaCopy.filter(c => c.id !== criterionId);
                    StateStore.setState({ customIdealityCriteria: updatedCriteria });
                }
            }

            function getAllSolutionsWithDetails() {
                const state = StateStore.getState();
                const solutionsList = [];
                function findSolutionsRecursive(node) {
                    if (!node) return;
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node);
                    if (hasPositiveChild && hasNegativeChild) {
                        if (node.solutionsGenerated && node.solutionsGenerated.length > 0) {
                            node.solutionsGenerated.forEach(sol => {
                                solutionsList.push({
                                    contradictionNodeId: node.id,
                                    contradictionNodeText: node.text,
                                    improvingParameter: node.improvingParameter,
                                    worseningParameter: node.worseningParameter,
                                    solutionId: sol.id,
                                    principleName: sol.principleName,
                                    description: sol.description,
                                    abcCategory: sol.abcCategory,
                                    timeRequired: sol.timeRequired,
                                    mcdmScore: sol.mcdmScore,
                                    cost: sol.cost,
                                    idealityAssessment: sol.idealityAssessment || Utils.getDefaultIdealityAssessment(state.customIdealityCriteria)
                                });
                            });
                        }
                    }
                    if (node.children && Array.isArray(node.children)) { node.children.forEach(findSolutionsRecursive); }
                }
                if (state.rcaData) findSolutionsRecursive(state.rcaData);
                return solutionsList;
            }

            function getCauseEffectTableData() {
                const state = StateStore.getState();
                const tableRowsData = [];
                function collectDataRecursive(node) {
                    if (!node) return;
                    if (node.type === 'cause') {
                        const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node);
                        let causeType = '';
                        if (node.isNonChangeable) causeType = 'NC';
                        else if (hasPositiveChild && hasNegativeChild) causeType = 'N+P (矛盾)';
                        else if (hasNegativeChild) causeType = 'N (純負面)';
                        else if (hasPositiveChild) causeType = 'P (純正面)';
                        else causeType = '未定義效果';

                        if (causeType !== 'P (純正面)' || (hasPositiveChild || hasNegativeChild)) {
                            const positiveEffects = (node.children && Array.isArray(node.children) ? node.children.filter(c => c && c.type === 'positive-effect').map(c => c.text).join('; ') : '') || '無';
                            const negativeEffects = (node.children && Array.isArray(node.children) ? node.children.filter(c => c && c.type === 'negative-effect').map(c => c.text).join('; ') : '') || '無';
                            tableRowsData.push({ cause: node.text, abc: node.abcCategory || '-', type: causeType, positive: positiveEffects, negative: negativeEffects });
                        }
                    }
                    if (node.children && Array.isArray(node.children)) node.children.forEach(collectDataRecursive);
                }
                if (state.rcaData) collectDataRecursive(state.rcaData);
                return tableRowsData;
            }

            return {
                setInitialProblem,
                findNodeById,
                checkChildrenEffects,
                addNode,
                updateNodeTextAndConnectorLabel,
                removeNode,
                toggleNonChangeable,
                // setAbcCategory, // 移除此功能
                setAndSources,
                setEffectParameters,
                setTrizParameters,
                addOrUpdateSolutionEntry,
                removeSolutionEntry,
                updateSolutionAbcCategory,
                updateSolutionIdealityAssessment,
                addOrUpdateCriterion,
                removeCriterion,
                getAllSolutionsWithDetails,
                getCauseEffectTableData
            };
        })();

        // --- 6. HistoryManager.js ---
        const HistoryManager = (function() {
            function pushState(currentState) {
                let { history, historyIndex } = StateStore.getState();
                history = history.slice(0, historyIndex + 1);
                history.push(currentState);
                historyIndex = history.length - 1;
                if (history.length > Constants.MAX_HISTORY_STATES) {
                    history.shift();
                    historyIndex--;
                }
                StateStore.setState({ history, historyIndex }, { pushToHistory: false, notify: false }); // Don't re-push or notify
            }

            function undo() {
                let { history, historyIndex } = StateStore.getState();
                if (historyIndex > 0) {
                    historyIndex--;
                    StateStore.restoreState(history[historyIndex]);
                    StateStore.setState({ historyIndex }, { pushToHistory: false, notify: false }); // Update historyIndex without triggering full state push/notify
                }
            }

            function redo() {
                let { history, historyIndex } = StateStore.getState();
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    StateStore.restoreState(history[historyIndex]);
                    StateStore.setState({ historyIndex }, { pushToHistory: false, notify: false }); // Update historyIndex without triggering full state push/notify
                }
            }

            return {
                pushState,
                undo,
                redo
            };
        })();

        // --- 7. DataManager.js ---
        const DataManager = (function() {

            function recalculateNodeIdCounter(currentData) {
                let maxId = 0;
                function findMaxIdRecursive(node) {
                    if (!node) return;
                    if (node.id && typeof node.id === 'string') {
                        const idNum = parseInt(node.id.replace('node-', ''));
                        if (!isNaN(idNum) && idNum > maxId) { maxId = idNum; }
                    }
                    if (node.children && Array.isArray(node.children)) { node.children.forEach(childNode => { if (childNode && typeof childNode === 'object') findMaxIdRecursive(childNode); }); }
                }
                if (currentData && typeof currentData === 'object') { findMaxIdRecursive(currentData); }
                return maxId;
            }

            function migrateNodeDataRecursive(node, customIdealityCriteria) {
                if (!node) return;
                if (typeof node.andSourceNodeIds === 'undefined') node.andSourceNodeIds = [];
                if (typeof node.effectParameters === 'undefined') node.effectParameters = [];
                // if (typeof node.connectorLabelToParent === 'undefined') node.connectorLabelToParent = ""; // 移除連接線標籤
                if (typeof node.improvingParameter === 'undefined') node.improvingParameter = null;
                if (typeof node.worseningParameter === 'undefined') node.worseningParameter = null;
                if (typeof node.solutionsGenerated === 'undefined') node.solutionsGenerated = [];
                // if (typeof node.abcCategory === 'undefined') node.abcCategory = null; // 移除原因ABC篩選

                // Migrate old inventivePrinciples to new solutionsGenerated structure
                if (node.inventivePrinciples && Array.isArray(node.inventivePrinciples)) {
                    node.inventivePrinciples.forEach(oldIp => {
                        if (!node.solutionsGenerated.some(s => s.principleName === oldIp.name && s.description === oldIp.solution)) {
                            node.solutionsGenerated.push({
                                id: `sol-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                principleName: oldIp.name, description: oldIp.solution,
                                abcCategory: oldIp.abcCategory || null, timeRequired: oldIp.timeRequired || null,
                                mcdmScore: oldIp.mcdmScore || null, cost: oldIp.cost || null,
                                idealityAssessment: oldIp.idealityAssessment || Utils.getDefaultIdealityAssessment(customIdealityCriteria)
                            });
                        }
                    });
                    delete node.inventivePrinciples;
                }

                if(node.solutionsGenerated) {
                    node.solutionsGenerated.forEach(sol => {
                        if (typeof sol.timeRequired === 'undefined') sol.timeRequired = null;
                        if (typeof sol.mcdmScore === 'undefined') sol.mcdmScore = null;
                        if (typeof sol.cost === 'undefined') sol.cost = null;
                        if (typeof sol.idealityAssessment === 'undefined' || sol.idealityAssessment === null || !Array.isArray(sol.idealityAssessment.criteria)) {
                            sol.idealityAssessment = Utils.getDefaultIdealityAssessment(customIdealityCriteria);
                            sol.mcdmScore = Utils.calculateWeightedScore(sol.idealityAssessment.criteria);
                        } else {
                            const newCriteriaState = [];
                            customIdealityCriteria.forEach(defaultCrit => {
                                const existingCrit = sol.idealityAssessment.criteria.find(c => c.id === defaultCrit.id);
                                newCriteriaState.push(existingCrit ? { ...existingCrit, name: defaultCrit.name, description: defaultCrit.description } : { ...defaultCrit });
                            });
                            sol.idealityAssessment.criteria = newCriteriaState.filter(crit => customIdealityCriteria.some(c => c.id === crit.id));
                            sol.idealityAssessment.weightedScore = Utils.calculateWeightedScore(sol.idealityAssessment.criteria);
                            sol.mcdmScore = sol.idealityAssessment.weightedScore;
                        }
                    });
                }
                if (node.children && Array.isArray(node.children)) { node.children.forEach(childNode => migrateNodeDataRecursive(childNode, customIdealityCriteria)); }
            }

            function processLoadedData(dataString) {
                try {
                    const parsedJson = JSON.parse(dataString);
                    if (!parsedJson || typeof parsedJson !== 'object' || typeof parsedJson.diagramData === 'undefined') {
                        alert('載入失敗：檔案內容不是有效的物件格式或資料缺失。'); return false;
                    }
                    if (parsedJson.diagramData !== null && typeof parsedJson.diagramData !== 'object') {
                        alert('載入失敗：圖表資料格式不正確。'); return false;
                    }

                    let loadedCustomIdealityCriteria = parsedJson.customIdealityCriteria ? Utils.deepCopy(parsedJson.customIdealityCriteria) : Utils.deepCopy(Constants.DEFAULT_IDEALITY_CRITERIA);

                    // Update criterionIdCounter based on loaded criteria
                    let maxCritId = 0;
                    loadedCustomIdealityCriteria.forEach(crit => {
                        const idNum = parseInt(crit.id.replace('crit-', ''));
                        if (!isNaN(idNum) && idNum > maxCritId) { maxCritId = idNum; }
                    });
                    // Merge new default criteria if they don't exist in loaded custom criteria
                    Constants.DEFAULT_IDEALITY_CRITERIA.forEach(defaultCrit => {
                        if (!loadedCustomIdealityCriteria.some(c => c.id === defaultCrit.id)) {
                            loadedCustomIdealityCriteria.push(Utils.deepCopy(defaultCrit));
                            const idNum = parseInt(defaultCrit.id.replace('crit-', ''));
                            if (!isNaN(idNum) && idNum > maxCritId) { maxCritId = idNum; }
                        }
                    });

                    let loadedRcaData = parsedJson.diagramData;
                    if (loadedRcaData) {
                        migrateNodeDataRecursive(loadedRcaData, loadedCustomIdealityCriteria);
                    }

                    const newRcaData = loadedRcaData;
                    const newNodeIdCounter = recalculateNodeIdCounter(newRcaData);
                    const newZoom = typeof parsedJson.zoomLevel === 'number' ? parsedJson.zoomLevel : 1.0;
                    // const newAbcCauseFilter = parsedJson.abcCauseFilter || parsedJson.abcFilter || 'all'; // 移除原因ABC篩選
                    const newAbcSolutionFilter = parsedJson.abcSolutionFilter || 'all';

                    StateStore.setState({
                        rcaData: newRcaData,
                        nodeIdCounter: newNodeIdCounter,
                        currentZoom: newZoom,
                        // currentAbcCauseFilter: newAbcCauseFilter, // 移除原因ABC篩選
                        currentAbcSolutionFilter: newAbcSolutionFilter,
                        customIdealityCriteria: loadedCustomIdealityCriteria,
                        criterionIdCounter: maxCritId,
                        history: [], // Clear history and re-push initial state
                        historyIndex: -1
                    }, { pushToHistory: false }); // Don't push to history yet, will be done after setting initial state
                    HistoryManager.pushState(StateStore.getState()); // Push the loaded state as the first history entry

                    alert('圖表進度已成功載入！');
                    return true;

                } catch (e) {
                    console.error("載入資料時發生錯誤:", e);
                    alert('載入失敗：檔案內容可能不是有效的JSON格式或已損毀。\n錯誤訊息: ' + e.message);
                    return false;
                }
            }

            function saveToLocalStorage() {
                const state = StateStore.getState();
                if (state.rcaData || state.rcaData === null) {
                    try {
                        localStorage.setItem('rcaDiagramData', JSON.stringify({
                            diagramData: state.rcaData,
                            nodeIdCounter: state.nodeIdCounter,
                            zoomLevel: state.currentZoom,
                            // abcCauseFilter: state.currentAbcCauseFilter, // 移除原因ABC篩選
                            abcSolutionFilter: state.currentAbcSolutionFilter,
                            customIdealityCriteria: state.customIdealityCriteria
                        }));
                        alert('圖表進度已儲存至瀏覽器！');
                    } catch (e) { console.error("Error saving to localStorage:", e); alert('儲存失敗，可能是瀏覽器儲存空間已滿或功能受限。'); }
                } else { alert('沒有圖表資料可儲存。'); }
            }

            function loadFromLocalStorage() {
                const savedDataString = localStorage.getItem('rcaDiagramData');
                if (savedDataString) { processLoadedData(savedDataString); }
                else { alert('瀏覽器中沒有儲存的圖表進度。'); }
            }

            function saveToFile() {
                const state = StateStore.getState();
                if (state.rcaData || state.rcaData === null) {
                    const jsonData = JSON.stringify({
                        diagramData: state.rcaData,
                        nodeIdCounter: state.nodeIdCounter,
                        zoomLevel: state.currentZoom,
                        // abcCauseFilter: state.currentAbcCauseFilter, // 移除原因ABC篩選
                        abcSolutionFilter: state.abcSolutionFilter,
                        customIdealityCriteria: state.customIdealityCriteria
                    }, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url;
                    a.download = `RCA+_Data-${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a); a.click();
                    document.body.removeChild(a); URL.revokeObjectURL(url);
                    alert('圖表資料已準備下載。');
                } else { alert('沒有圖表資料可儲存至檔案。'); }
            }

            function loadFromFile(event) {
                const file = event.target.files[0];
                const inputElement = event.target;
                if (file) {
                    if (file.type === "application/json" || file.name.endsWith(".json")) {
                        const reader = new FileReader();
                        reader.onload = (e) => { processLoadedData(e.target.result); inputElement.value = ''; };
                        reader.onerror = (e) => { alert('讀取檔案時發生錯誤。'); console.error("FileReader error:", e); inputElement.value = ''; };
                        reader.readAsText(file);
                    } else { alert('載入失敗：請選擇一個有效的 .json 檔案。'); inputElement.value = ''; }
                }
            }

            return {
                saveToLocalStorage,
                loadFromLocalStorage,
                saveToFile,
                loadFromFile
            };
        })();

        // --- 8. RcaDiagramRenderer.js ---
        const RcaDiagramRenderer = (function() {
            let domElements = {};
            let currentZoom = 1.0; // Internal state for renderer, synced with StateStore

            function init(elements) {
                domElements = elements;
                StateStore.subscribe(handleStateChange);
                if (domElements.scalableContentWrapper) {
                    new ResizeObserver(() => drawConnectors()).observe(domElements.scalableContentWrapper);
                }
            }

            function handleStateChange(state) {
                // Only re-render diagram if rcaData or filter/view mode changes
                const shouldRenderDiagram = (
                    JSON.stringify(state.rcaData) !== JSON.stringify(domElements.diagramContainer.__lastRcaData) ||
                    state.isFinalizedView !== domElements.diagramContainer.__lastIsFinalizedView
                    // || state.currentAbcCauseFilter !== domElements.diagramContainer.__lastAbcCauseFilter // 移除原因ABC篩選
                );
                if (shouldRenderDiagram) {
                    renderDiagram(state.rcaData, state.isFinalizedView); // 移除 currentAbcCauseFilter 參數
                    domElements.diagramContainer.__lastRcaData = Utils.deepCopy(state.rcaData);
                    domElements.diagramContainer.__lastIsFinalizedView = state.isFinalizedView;
                    // domElements.diagramContainer.__lastAbcCauseFilter = state.currentAbcCauseFilter; // 移除原因ABC篩選
                }

                // Apply zoom if it changes
                if (state.currentZoom !== currentZoom) {
                    applyZoom(state.currentZoom, false);
                }
            }

            function renderDiagram(rcaData, isFinalizedView) { // 移除 currentAbcCauseFilter 參數
                domElements.diagramContainer.innerHTML = '';
                if (rcaData) {
                    domElements.diagramContainer.appendChild(createNodeElement(rcaData, isFinalizedView)); // 移除 currentAbcCauseFilter 參數
                    domElements.diagramTitle.style.display = 'block';
                    domElements.problemInputArea.style.display = 'none';
                } else {
                    domElements.diagramTitle.style.display = 'none';
                    domElements.problemInputArea.style.display = 'flex';
                }
                requestAnimationFrame(() => drawConnectors());
            }

            function createNodeElement(nodeData, isFinalizedView) { // 移除 currentAbcCauseFilter 參數
                const nodeWrapper = document.createElement('div');
                nodeWrapper.classList.add('rca-node-wrapper');

                const nodeDiv = document.createElement('div');
                nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`);
                nodeDiv.id = nodeData.id;
                nodeDiv.dataset.nodeId = nodeData.id;

                // 移除原因節點的 ABC 分類視覺效果判斷
                // if (nodeData.type === 'cause') {
                //     const isDimmed = (currentAbcCauseFilter === 'none' && (nodeData.abcCategory !== null && typeof nodeData.abcCategory !== 'undefined')) ||
                //                      (currentAbcCauseFilter !== 'all' && currentAbcCauseFilter !== 'none' && nodeData.abcCategory !== currentAbcCauseFilter);
                //     if (isDimmed) nodeDiv.classList.add('dimmed');
                // }

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('rca-node-content');

                const headerDiv = document.createElement('div');
                headerDiv.classList.add('rca-node-header');
                const textSpan = document.createElement('span');
                textSpan.classList.add('rca-node-text');
                textSpan.textContent = nodeData.text;
                headerDiv.appendChild(textSpan);

                // 移除顯示 ABC 標籤 (僅限原因節點)
                // if (nodeData.type === 'cause' && nodeData.abcCategory) {
                //     const abcBadge = document.createElement('span');
                //     abcBadge.classList.add('abc-badge', `abc-badge-${nodeData.abcCategory}`);
                //     abcBadge.textContent = nodeData.abcCategory;
                //     nodeDiv.appendChild(abcBadge);
                // }
                if (nodeData.type === 'cause' && nodeData.isNonChangeable) {
                    const ncBadge = document.createElement('span');
                    ncBadge.classList.add('node-badge');
                    ncBadge.textContent = 'NC';
                    headerDiv.appendChild(ncBadge);
                }
                contentDiv.appendChild(headerDiv);

                const iconSpan = document.createElement('span');
                iconSpan.classList.add('rca-node-icon');
                if (nodeData.type === 'initial-problem') {
                    iconSpan.textContent = '(-)';
                } else if (['cause', 'positive-effect', 'negative-effect'].includes(nodeData.type)) {
                    const { hasPositiveChild, hasNegativeChild } = RcaProcessor.checkChildrenEffects(nodeData);
                    if (hasPositiveChild && hasNegativeChild) {
                        iconSpan.textContent = '+/-';
                        iconSpan.classList.add('contradictory');
                    } else {
                        iconSpan.style.display = 'none';
                    }
                } else if (nodeData.type === 'positive-effect') {
                    iconSpan.textContent = '(+)';
                } else if (nodeData.type === 'negative-effect') {
                    iconSpan.textContent = '(-)';
                } else {
                    iconSpan.style.display = 'none';
                }

                if (nodeData.type === 'initial-problem') iconSpan.style.backgroundColor = '#ef4444';
                else if (iconSpan.classList.contains('contradictory')) iconSpan.style.backgroundColor = '#8b5cf6';
                else if (nodeData.type === 'positive-effect') iconSpan.style.backgroundColor = '#2563eb';
                else if (nodeData.type === 'negative-effect') iconSpan.style.backgroundColor = '#f97316';
                nodeDiv.appendChild(iconSpan);

                if ((nodeData.improvingParameter || nodeData.worseningParameter)) {
                    let paramsText = '';
                    if (nodeData.improvingParameter && nodeData.improvingParameter !== "未選擇") paramsText += `↑ ${nodeData.improvingParameter}`;
                    if (nodeData.worseningParameter && nodeData.worseningParameter !== "未選擇") paramsText += `${paramsText ? ' ' : ''}↓ ${nodeData.worseningParameter}`;
                    if (paramsText) {
                        const trizParamsDiv = document.createElement('div');
                        trizParamsDiv.classList.add('engineering-param-display');
                        trizParamsDiv.innerHTML = `<strong>衝突參數:</strong> ${paramsText}`;
                        contentDiv.appendChild(trizParamsDiv);
                    }
                }

                if (nodeData.effectParameters && nodeData.effectParameters.length > 0) {
                    const paramsDiv = document.createElement('div');
                    paramsDiv.classList.add('selected-items-list');
                    paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`;
                    contentDiv.appendChild(paramsDiv);
                }

                // Edit mode actions
                if (!isFinalizedView) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('rca-node-actions');

                    actionsDiv.appendChild(Utils.createActionButton('修訂此項', 'edit-node', () => promptEditNode(nodeData.id, contentDiv)));

                    if (nodeData.type === 'initial-problem') {
                        actionsDiv.appendChild(Utils.createActionButton('新增原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入原因描述'))); // 移除 connectorLabelPlaceholderText
                    } else if (nodeData.type === 'cause') {
                        actionsDiv.appendChild(Utils.createActionButton('新增子原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入子原因描述'))); // 移除 connectorLabelPlaceholderText
                        actionsDiv.appendChild(Utils.createActionButton('(+) 正面效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入此原因帶來的正面效果'))); // 移除 connectorLabelPlaceholderText
                        actionsDiv.appendChild(Utils.createActionButton('(-) 負面效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入此原因導致的負面效果'))); // 移除 connectorLabelPlaceholderText
                        actionsDiv.appendChild(Utils.createActionButton(nodeData.isNonChangeable ? '取消NC標記' : '設為NC', 'toggle-nc', () => RcaProcessor.toggleNonChangeable(nodeData.id)));
                        // actionsDiv.appendChild(Utils.createActionButton('設定ABC分類', 'set-abc', () => ModalManager.openAbcCategoryModal(nodeData.id))); // 移除此功能
                    } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') {
                        actionsDiv.appendChild(Utils.createActionButton('(+) 新增正面子效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述'))); // 移除 connectorLabelPlaceholderText
                        actionsDiv.appendChild(Utils.createActionButton('(-) 新增負面子效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述'))); // 移除 connectorLabelPlaceholderText
                        actionsDiv.appendChild(Utils.createActionButton('設定效果參數', 'set-parameters', () => ModalManager.openEffectParameterModal(nodeData.id)));
                        actionsDiv.appendChild(Utils.createActionButton('設定AND輸入源', 'set-and-sources', () => ModalManager.openAndSourceModal(nodeData.id)));
                    }

                    const { hasPositiveChild, hasNegativeChild } = RcaProcessor.checkChildrenEffects(nodeData);
                    if (hasPositiveChild && hasNegativeChild) {
                        actionsDiv.appendChild(Utils.createActionButton('設定衝突參數/方案', 'set-triz', () => ModalManager.openTrizSolutionModal(nodeData.id)));
                    }

                    if (nodeData.id !== StateStore.getState().rcaData.id) {
                        actionsDiv.appendChild(Utils.createActionButton('移除此項', 'remove-button', () => RcaProcessor.removeNode(nodeData.id)));
                    }
                    
                    contentDiv.appendChild(actionsDiv);
                    const inputContainer = document.createElement('div');
                    inputContainer.classList.add('input-group-container');
                    contentDiv.appendChild(inputContainer);
                }

                nodeDiv.appendChild(contentDiv);
                nodeWrapper.appendChild(nodeDiv);

                if (nodeData.children && Array.isArray(nodeData.children) && nodeData.children.length > 0) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.classList.add('rca-children-container');
                    nodeData.children.forEach(childNode => {
                        if (childNode && typeof childNode === 'object') childrenContainer.appendChild(createNodeElement(childNode, isFinalizedView)); // 移除 currentAbcCauseFilter
                    });
                    nodeWrapper.appendChild(childrenContainer);
                }
                return nodeWrapper;
            }

            function promptEditNode(nodeId, parentNodeContentDiv) {
                const state = StateStore.getState();
                if (state.isFinalizedView) { alert('目前處於檢視模式，請切換到編輯模式以修改節點。'); return; }
                const nodeToEdit = RcaProcessor.findNodeById(state.rcaData, nodeId);
                if (!nodeToEdit) return;

                const inputContainer = parentNodeContentDiv.querySelector('.input-group-container');
                if (!inputContainer) { console.error("Input container not found for node:", nodeId); return; }

                document.querySelectorAll('.input-group').forEach(ig => ig.remove());
                inputContainer.innerHTML = '';

                const inputGroup = document.createElement('div');
                inputGroup.classList.add('input-group');

                const nodeInput = document.createElement('input');
                nodeInput.type = 'text';
                nodeInput.value = nodeToEdit.text;
                nodeInput.classList.add('input-field');
                inputGroup.appendChild(nodeInput);

                // 移除連接線標籤輸入框
                // let connectorLabelInput;
                // if (nodeToEdit.parentId) {
                //     connectorLabelInput = document.createElement('input');
                //     connectorLabelInput.type = 'text';
                //     connectorLabelInput.value = nodeToEdit.connectorLabelToParent || "";
                //     connectorLabelInput.placeholder = "與父節點關係描述 (選填)";
                //     connectorLabelInput.classList.add('input-field', 'mt-2');
                //     inputGroup.appendChild(connectorLabelInput);
                // }

                const saveEditButton = Utils.createActionButton('儲存修訂', 'save-edit-button w-full mt-2', () => {
                    const newText = nodeInput.value.trim();
                    if (newText) {
                        RcaProcessor.updateNodeTextAndConnectorLabel(nodeId, newText); // 移除 connectorLabelInput.value.trim()
                        inputContainer.innerHTML = '';
                    } else { alert('描述不能為空！'); }
                });
                nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveEditButton.click(); });
                // if (connectorLabelInput) connectorLabelInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveEditButton.click(); }); // 移除連接線標籤

                const cancelButton = Utils.createActionButton('取消修訂', 'bg-gray-400 hover:bg-gray-500 w-full mt-1', () => { inputContainer.innerHTML = ''; });

                inputGroup.appendChild(saveEditButton);
                inputGroup.appendChild(cancelButton);
                inputContainer.appendChild(inputGroup);
                nodeInput.focus();
                nodeInput.select();
            }

            function promptAddNode(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) { // 移除 connectorLabelPlaceholderText
                const state = StateStore.getState();
                if (state.isFinalizedView) return;
                const inputContainer = parentNodeContentDiv.querySelector('.input-group-container');
                if (!inputContainer) return;

                inputContainer.innerHTML = '';
                document.querySelectorAll('.input-group').forEach(ig => ig.remove());

                const inputGroup = document.createElement('div');
                inputGroup.classList.add('input-group');

                const nodeInput = document.createElement('input');
                nodeInput.type = 'text';
                nodeInput.placeholder = placeholderText;
                nodeInput.classList.add('input-field');
                inputGroup.appendChild(nodeInput);

                // 移除連接線標籤輸入框
                // const connectorLabelInput = document.createElement('input');
                // connectorLabelInput.type = 'text';
                // connectorLabelInput.value = connectorLabelPlaceholderText;
                // connectorLabelInput.placeholder = connectorLabelPlaceholderText;
                // connectorLabelInput.classList.add('input-field', 'mt-2');
                // inputGroup.appendChild(connectorLabelInput);

                const saveButton = Utils.createActionButton('儲存', 'save-button w-full mt-2', () => {
                    const newText = nodeInput.value.trim();
                    // const connectorLabel = connectorLabelInput.value.trim(); // 移除連接線標籤
                    if (newText) {
                        RcaProcessor.addNode(parentId, newText, nodeTypeToAdd); // 移除 connectorLabel
                        inputContainer.innerHTML = '';
                    } else { alert('描述不能為空！'); }
                });
                nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); });
                // connectorLabelInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); }); // 移除連接線標籤

                const cancelButton = Utils.createActionButton('取消', 'bg-gray-400 hover:bg-gray-500 w-full mt-1', () => { inputContainer.innerHTML = ''; });

                inputGroup.appendChild(saveButton);
                inputGroup.appendChild(cancelButton);
                inputContainer.appendChild(inputGroup);
                nodeInput.focus();
            }

            function drawConnectors(targetSvgLayer = domElements.svgLayer, targetDiagramContainer = domElements.diagramContainer, targetScalableWrapper = domElements.scalableContentWrapper, zoom = StateStore.getState().currentZoom) {
                const state = StateStore.getState();
                const { rcaData } = state;
                
                if (!targetSvgLayer || !targetDiagramContainer || !targetScalableWrapper) return;
                targetSvgLayer.innerHTML = '';

                if (!rcaData || !targetDiagramContainer.querySelector(`#${rcaData.id}`)) {
                    targetSvgLayer.setAttribute('width', 0);
                    targetSvgLayer.setAttribute('height', 0);
                    return;
                }

                const wrapperStyle = getComputedStyle(targetScalableWrapper);
                const wrapperPaddingLeft = parseFloat(wrapperStyle.paddingLeft) || 0;
                const wrapperPaddingTop = parseFloat(wrapperStyle.paddingTop) || 0;

                // Use the actual scroll dimensions of the content wrapper
                const unscaledDiagramWidth = targetDiagramContainer.scrollWidth;
                const unscaledDiagramHeight = targetDiagramContainer.scrollHeight;

                targetSvgLayer.setAttribute('width', unscaledDiagramWidth);
                targetSvgLayer.setAttribute('height', unscaledDiagramHeight);
                targetSvgLayer.setAttribute('viewBox', `0 0 ${unscaledDiagramWidth} ${unscaledDiagramHeight}`);

                const lineVerticalOffset = 25;
                const scalableWrapperRect = targetScalableWrapper.getBoundingClientRect();

                function _drawSvgLine(svg, x1, y1, x2, y2, color = 'black', strokeWidth = 2, zoomFactor = 1) {
                    if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) { return; }
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', color);
                    line.setAttribute('stroke-width', strokeWidth / zoomFactor);
                    svg.appendChild(line);
                }

                function _drawSvgCircle(svg, cx, cy, r, fillColor = 'black', zoomFactor = 1) {
                    if (isNaN(cx) || isNaN(cy) || isNaN(r)) { return; }
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', cx);
                    circle.setAttribute('cy', cy);
                    circle.setAttribute('r', r / zoomFactor);
                    circle.setAttribute('fill', fillColor);
                    svg.appendChild(circle);
                }

                // 移除 _drawSvgTextWithBackground 函式，因為不再需要繪製連接線標籤
                // function _drawSvgTextWithBackground(svg, textContent, x, y, fontSize, fillColor, zoomFactor = 1) {
                //     if (isNaN(x) || isNaN(y)) return;

                //     const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                //     textElement.setAttribute('x', x);
                //     textElement.setAttribute('y', y);
                //     textElement.setAttribute('font-size', fontSize);
                //     textElement.setAttribute('fill', fillColor);
                //     textElement.setAttribute('text-anchor', 'middle');
                //     textElement.setAttribute('dominant-baseline', 'middle');
                //     textElement.classList.add('connector-label-text');
                //     textElement.textContent = textContent;
                //     svg.appendChild(textElement);

                //     const bbox = textElement.getBBox();
                //     svg.removeChild(textElement);

                //     const padding = 2 / zoomFactor;
                //     const rectElement = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                //     rectElement.setAttribute('x', bbox.x - padding);
                //     rectElement.setAttribute('y', bbox.y - padding);
                //     rectElement.setAttribute('width', bbox.width + (2 * padding));
                //     rectElement.setAttribute('height', bbox.height + (2 * padding));
                //     rectElement.setAttribute('rx', 2 / zoomFactor);
                //     rectElement.setAttribute('ry', 2 / zoomFactor);
                //     rectElement.classList.add('connector-label-bg');
                //     svg.appendChild(rectElement);
                //     svg.appendChild(textElement);
                // }

                function drawRecursive(parentNodeData, currentContainer) {
                    const parentElement = currentContainer.querySelector(`#${parentNodeData.id}`);
                    if (!parentElement) return;

                    const parentRect = parentElement.getBoundingClientRect();
                    const parentBottomCenterX_svg = (parentRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + parentRect.width / 2) / zoom;
                    const parentBottomY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + parentRect.height) / zoom;
                    const parentTopY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom;
                    const parentCenterX_svg = parentBottomCenterX_svg;

                    if (parentNodeData.andSourceNodeIds && parentNodeData.andSourceNodeIds.length > 0) {
                        const mergePointYOffset = 40;
                        const mergePoint_svg = { x: parentCenterX_svg, y: parentTopY_svg - mergePointYOffset };
                        if(mergePoint_svg.y < 0) mergePoint_svg.y = 10;
                        _drawSvgCircle(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, 6, '#6d28d9', zoom);

                        parentNodeData.andSourceNodeIds.forEach(sourceId => {
                            const sourceElement = domElements.diagramContainer.querySelector(`#${sourceId}`);
                            if (sourceElement) {
                                const sourceRect = sourceElement.getBoundingClientRect();
                                const sourceConnX_svg = (sourceRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + sourceRect.width / 2) / zoom;
                                const sourceConnY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + sourceRect.height) / zoom;
                                if (sourceConnY_svg < mergePoint_svg.y) {
                                    _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceConnY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom);
                                } else {
                                    const sourceTopY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom;
                                    _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceTopY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom);
                                }
                            }
                        });
                        if (parentTopY_svg > mergePoint_svg.y) {
                            _drawSvgLine(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, parentCenterX_svg, parentTopY_svg, '#6b7280', 2, zoom);
                        }
                    }

                    const standardChildren = parentNodeData.children ? parentNodeData.children.filter(c => c && !(c.andSourceNodeIds && c.andSourceNodeIds.length > 0 && c.andSourceNodeIds.includes(parentNodeData.id))) : [];

                    if (standardChildren.length > 0) {
                        const horizontalLineY_svg = parentBottomY_svg + lineVerticalOffset;
                        _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, parentBottomY_svg, parentBottomCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom);

                        if (standardChildren.length > 1) {
                            const firstChildElement = currentContainer.querySelector(`#${standardChildren[0].id}`);
                            const lastChildElement = currentContainer.querySelector(`#${standardChildren[standardChildren.length - 1].id}`);
                            if (firstChildElement && lastChildElement) {
                                const firstChildRect = firstChildElement.getBoundingClientRect();
                                const lastChildRect = lastChildElement.getBoundingClientRect();
                                const hLineStartX_svg = (firstChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + firstChildRect.width / 2) / zoom;
                                const hLineEndX_svg = (lastChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + lastChildRect.width / 2) / zoom;
                                if (Math.abs(hLineStartX_svg - hLineEndX_svg) > 1) { _drawSvgLine(targetSvgLayer, hLineStartX_svg, horizontalLineY_svg, hLineEndX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); }
                            }
                        } else if (standardChildren.length === 1) {
                            const childElement = currentContainer.querySelector(`#${standardChildren[0].id}`);
                            if (childElement) {
                                const childRect = childElement.getBoundingClientRect();
                                const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom;
                                if (Math.abs(parentBottomCenterX_svg - childCenterX_svg) > 1) { _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, horizontalLineY_svg, childCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); }
                            }
                        }

                        standardChildren.forEach(childNode => {
                            if (!childNode) return;
                            const childElement = currentContainer.querySelector(`#${childNode.id}`);
                            if (childElement) {
                                const childRect = childElement.getBoundingClientRect();
                                const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom;
                                const childTopY_svg = (childRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom;
                                if (childTopY_svg > horizontalLineY_svg) {
                                    _drawSvgLine(targetSvgLayer, childCenterX_svg, horizontalLineY_svg, childCenterX_svg, childTopY_svg, '#9ca3af', 2, zoom);
                                    // 移除繪製連接線標籤的程式碼
                                    // if (childNode.connectorLabelToParent && childNode.connectorLabelToParent.trim() !== "") {
                                    //     _drawSvgTextWithBackground(targetSvgLayer, childNode.connectorLabelToParent, childCenterX_svg, (horizontalLineY_svg + childTopY_svg) / 2, 10 / zoom, '#333333', zoom);
                                    // }
                                }
                            }
                        });
                    }
                    if (parentNodeData.children && Array.isArray(parentNodeData.children)) { parentNodeData.children.forEach(childNode => { if (childNode && typeof childNode === 'object') drawRecursive(childNode, currentContainer); }); }
                }
                if(rcaData && typeof rcaData === 'object') drawRecursive(rcaData, targetDiagramContainer); // Pass targetDiagramContainer to recursive call
            }

            function applyZoom(newZoomLevel, triggerStateUpdate = true) {
                currentZoom = Math.max(Constants.MIN_ZOOM, Math.min(Constants.MAX_ZOOM, newZoomLevel));
                domElements.scalableContentWrapper.style.transform = `scale(${currentZoom})`;
                domElements.zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`;
                if (triggerStateUpdate) {
                    StateStore.setState({ currentZoom: currentZoom }, { pushToHistory: false }); // Update state without pushing history
                }
                requestAnimationFrame(() => drawConnectors());
            }

            async function exportAsPNG() {
                const state = StateStore.getState();
                if (!state.rcaData || !domElements.scalableContentWrapper || !domElements.diagramContainer || domElements.diagramContainer.children.length === 0) {
                    alert('圖表為空或找不到圖表元素！'); return;
                }

                const activeInputGroups = domElements.diagramContainer.querySelectorAll('.input-group');
                activeInputGroups.forEach(group => group.style.display = 'none');
                if (domElements.fileDropdownContent && domElements.fileDropdownContent.style.display === 'block') domElements.fileDropdownContent.style.display = 'none';

                const originalRenderAreaScrollX = domElements.diagramRenderArea ? domElements.diagramRenderArea.scrollLeft : 0;
                const originalRenderAreaScrollY = domElements.diagramRenderArea ? domElements.diagramRenderArea.scrollTop : 0;
                const originalZoom = state.currentZoom;

                // Temporarily adjust state for export and force redraw on original elements
                if(domElements.diagramRenderArea) { domElements.diagramRenderArea.scrollLeft = 0; domElements.diagramRenderArea.scrollTop = 0; }
                StateStore.setState({ currentZoom: 1.0 }, { pushToHistory: false }); // Set zoom to 1.0 for capture
                
                // Ensure original SVG redraws first
                await new Promise(resolve => requestAnimationFrame(() => {
                    drawConnectors(domElements.svgLayer, domElements.diagramContainer, domElements.scalableContentWrapper, 1.0); // Explicitly draw on original elements
                    resolve();
                }));
                await new Promise(resolve => setTimeout(resolve, 100)); // Short delay for original render

                const exportContainer = document.createElement('div');
                exportContainer.id = 'export-temp-container';
                // Use `overflow: visible` for export container to prevent clipping issues
                exportContainer.style.cssText = 'position:absolute;left:-99999px;top:-99999px;background-color:#ffffff;padding:0;margin:0;overflow:visible;';

                // Get the actual rendered size of the content after zoom 1.0 and redraw
                // This is crucial: we need the *current* scroll dimensions of the wrapper
                const contentWidth = domElements.scalableContentWrapper.scrollWidth;
                const contentHeight = domElements.scalableContentWrapper.scrollHeight;
                exportContainer.style.width = contentWidth + 'px';
                exportContainer.style.height = contentHeight + 'px';

                const clonedScalableContent = domElements.scalableContentWrapper.cloneNode(true);
                // Ensure cloned content also has correct styling for capture
                clonedScalableContent.style.cssText = `
                    transform:scale(1.0);
                    margin:0;
                    padding:${getComputedStyle(domElements.scalableContentWrapper).padding};
                    background-color:#ffffff;
                    cursor:default;
                    display: inline-block; /* Ensure it takes its natural width/height */
                    position: relative; /* Important for absolute children like SVG */
                `;

                // Hide interactive elements on the cloned content
                clonedScalableContent.querySelectorAll('.rca-node-cause').forEach(node => node.classList.remove('dimmed'));
                clonedScalableContent.querySelectorAll('.rca-node-actions').forEach(div => div.style.display = 'none');
                clonedScalableContent.querySelectorAll('.input-group-container').forEach(div => div.style.display = 'none');
                clonedScalableContent.querySelectorAll('.rca-node').forEach(node => node.style.boxShadow = 'none');

                exportContainer.appendChild(clonedScalableContent);
                document.body.appendChild(exportContainer);

                const clonedDiagramContainer = clonedScalableContent.querySelector('#rca-diagram-container');
                const clonedSvgLayer = clonedScalableContent.querySelector('#svg-connector-layer');

                // Explicitly set SVG dimensions on the cloned layer based on the cloned diagram container's size
                // This ensures the SVG canvas matches the content area for drawing
                if (clonedSvgLayer && clonedDiagramContainer) {
                    const unscaledClonedDiagramWidth = clonedDiagramContainer.scrollWidth;
                    const unscaledClonedDiagramHeight = clonedDiagramContainer.scrollHeight;
                    clonedSvgLayer.setAttribute('width', unscaledClonedDiagramWidth);
                    clonedSvgLayer.setAttribute('height', unscaledClonedDiagramHeight);
                    clonedSvgLayer.setAttribute('viewBox', `0 0 ${unscaledClonedDiagramWidth} ${unscaledClonedDiagramHeight}`);
                    // Redraw connectors on the CLONED SVG
                    await new Promise(resolve => requestAnimationFrame(() => {
                        drawConnectors(clonedSvgLayer, clonedDiagramContainer, clonedScalableContent, 1.0);
                        resolve();
                    }));
                }

                await new Promise(resolve => setTimeout(resolve, 500)); // Increased delay for html2canvas to capture

                try {
                    const canvas = await html2canvas(exportContainer, {
                        scale: 1.5,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'RCA+_Diagram.png';
                    link.href = image;
                    link.click();
                } catch (err) {
                    console.error('匯出圖表失敗:', err);
                    alert('匯出圖表失敗，請檢查控制台錯誤訊息。');
                } finally {
                    document.body.removeChild(exportContainer);
                    activeInputGroups.forEach(group => group.style.display = 'flex');
                    // Restore original state
                    StateStore.setState({
                        currentZoom: originalZoom,
                    }, { pushToHistory: false });
                    if(domElements.diagramRenderArea) {
                        domElements.diagramRenderArea.scrollLeft = originalRenderAreaScrollX;
                        domElements.diagramRenderArea.scrollTop = originalRenderAreaScrollY;
                    }
                }
            }

            return {
                init,
                renderDiagram,
                drawConnectors,
                applyZoom,
                exportAsPNG
            };
        })();

        // --- 9. ModalManager.js ---
        const ModalManager = (function() {
            let domElements = {};

            function init(elements) {
                domElements = elements;
                // Add event listeners for all modal close buttons
                document.querySelectorAll('.modal-close-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const modalId = e.target.dataset.modalId;
                        if (modalId && domElements[modalId]) {
                            domElements[modalId].style.display = 'none';
                            // Reset current active modal IDs in StateStore
                            // if (modalId === 'abc-category-modal') StateStore.setState({ currentAbcCauseTargetNodeId: null }, { pushToHistory: false }); // 移除原因ABC篩選
                            if (modalId === 'triz-solution-modal') StateStore.setState({ currentTrizContradictionNodeId: null }, { pushToHistory: false });
                            if (modalId === 'ideality-assessment-modal') StateStore.setState({ currentAssessingSolution: { contradictionNodeId: null, solutionId: null } }, { pushToHistory: false });
                            if (modalId === 'and-source-modal') StateStore.setState({ currentAndTargetNodeId: null }, { pushToHistory: false });
                            if (modalId === 'effect-parameter-modal') StateStore.setState({ currentParameterTargetNodeId: null }, { pushToHistory: false });
                        }
                    });
                });

                // Specific modal save/cancel buttons
                domElements.saveAndSourcesButton.addEventListener('click', handleSaveAndSources);
                domElements.cancelAndSourcesButton.addEventListener('click', () => { domElements.andSourceModal.style.display = 'none'; StateStore.setState({ currentAndTargetNodeId: null }, { pushToHistory: false }); });

                domElements.saveEffectParametersButton.addEventListener('click', handleSaveEffectParameters);
                domElements.cancelEffectParametersButton.addEventListener('click', () => { domElements.effectParameterModal.style.display = 'none'; StateStore.setState({ currentParameterTargetNodeId: null }, { pushToHistory: false }); });

                domElements.improvingParameterSelect.addEventListener('change', handleTrizParameterChange);
                domElements.worseningParameterSelect.addEventListener('change', handleTrizParameterChange);
                domElements.addNewSolutionEntryButton.addEventListener('click', () => showEditSolutionEntry(null));
                domElements.saveSolutionEntryButton.addEventListener('click', handleSaveSolutionEntry);
                domElements.cancelEditSolutionButton.addEventListener('click', () => {
                    domElements.editSolutionEntryContainer.style.display = 'none';
                    domElements.editingSolutionIdInput.value = '';
                });
                domElements.closeTrizModalButton.addEventListener('click', () => { domElements.trizSolutionModal.style.display = 'none'; StateStore.setState({ currentTrizContradictionNodeId: null }, { pushToHistory: false }); });

                domElements.saveIdealityAssessmentButton.addEventListener('click', handleSaveIdealityAssessment);
                domElements.cancelIdealityAssessmentButton.addEventListener('click', () => { domElements.idealityAssessmentModal.style.display = 'none'; StateStore.setState({ currentAssessingSolution: { contradictionNodeId: null, solutionId: null } }, { pushToHistory: false }); });
                domElements.resetIdealityWeightsButton.addEventListener('click', resetIdealityWeights);
            }

            // function openAbcCategoryModal(nodeId) { // 移除此功能
            //     const state = StateStore.getState();
            //     if (state.isFinalizedView) return;
            //     const node = RcaProcessor.findNodeById(state.rcaData, nodeId);
            //     if (!node || node.type !== 'cause') { alert('只能為原因節點設定ABC分類。'); return; }

            //     StateStore.setState({ currentAbcCauseTargetNodeId: nodeId }, { pushToHistory: false });

            //     domElements.abcCategoryModal.querySelector('#abc-modal-node-text').textContent = `節點：${node.text.substring(0,30)}${node.text.length > 30 ? '...' : ''}`;
            //     domElements.abcCategoryModal.querySelectorAll('button[data-abc-cause]').forEach(btn => {
            //         btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
            //         if (btn.dataset.abc-cause === (node.abcCategory || 'null')) { btn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500'); }
            //         // Attach click listener if not already done (ensure only once)
            //         if (!btn.dataset.listenerAttached) {
            //             btn.addEventListener('click', (event) => {
            //                 const category = event.target.dataset.abc-cause === 'null' ? null : event.target.dataset.abc-cause;
            //                 RcaProcessor.setAbcCategory(StateStore.getState().currentAbcCauseTargetNodeId, category);
            //                 domElements.abcCategoryModal.style.display = 'none';
            //                 StateStore.setState({ currentAbcCauseTargetNodeId: null }, { pushToHistory: false });
            //             });
            //             btn.dataset.listenerAttached = true;
            //         }
            //     });
            //     domElements.abcCategoryModal.style.display = 'flex';
            // }

            function openAndSourceModal(targetNodeId) {
                const state = StateStore.getState();
                if (state.isFinalizedView) return;
                const targetNode = RcaProcessor.findNodeById(state.rcaData, targetNodeId);
                if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) { alert('只能為「效果」節點設定 AND 輸入源。'); return; }

                StateStore.setState({ currentAndTargetNodeId: targetNodeId }, { pushToHistory: false });

                domElements.andSourceModalNodeText.textContent = `為效果「${targetNode.text.substring(0,30)}...」設定 AND 輸入源:`;
                domElements.andSourceOptionsContainer.innerHTML = '';

                const potentialSources = [];
                function collectPotentialSourcesRecursive(node) {
                    if (!node) return;
                    if (node.id !== targetNodeId && (node.type === 'cause' || node.type === 'initial-problem')) {
                        potentialSources.push({ id: node.id, text: node.text });
                    }
                    if (node.children) node.children.forEach(collectPotentialSourcesRecursive);
                }
                collectPotentialSourcesRecursive(state.rcaData);

                if (potentialSources.length === 0) {
                    domElements.andSourceOptionsContainer.innerHTML = '<p class="text-sm text-gray-500">沒有可用的 AND 輸入源節點 (原因或主要問題)。</p>';
                } else {
                    potentialSources.forEach(source => {
                        const label = document.createElement('label');
                        label.className = 'block text-sm text-gray-700 mb-1';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = source.id;
                        checkbox.name = 'andSourceOption';
                        checkbox.className = 'mr-2 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50';
                        if (targetNode.andSourceNodeIds && targetNode.andSourceNodeIds.includes(source.id)) { checkbox.checked = true; }
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(`${source.text.substring(0,40)}... (ID: ${source.id})`));
                        domElements.andSourceOptionsContainer.appendChild(label);
                    });
                }
                domElements.andSourceModal.style.display = 'flex';
            }

            function handleSaveAndSources() {
                const state = StateStore.getState();
                if (!state.currentAndTargetNodeId) return;
                const selectedSources = [];
                domElements.andSourceOptionsContainer.querySelectorAll('input[name="andSourceOption"]:checked').forEach(checkbox => { selectedSources.push(checkbox.value); });
                RcaProcessor.setAndSources(state.currentAndTargetNodeId, selectedSources);
                domElements.andSourceModal.style.display = 'none';
                StateStore.setState({ currentAndTargetNodeId: null }, { pushToHistory: false });
            }

            function openEffectParameterModal(targetNodeId) {
                const state = StateStore.getState();
                if (state.isFinalizedView) return;
                const targetNode = RcaProcessor.findNodeById(state.rcaData, targetNodeId);
                if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) { alert('只能為正面或負面效果節點設定效果參數。'); return; }

                StateStore.setState({ currentParameterTargetNodeId: targetNodeId }, { pushToHistory: false });

                domElements.effectParameterModalNodeText.textContent = `為效果「${targetNode.text.substring(0,30)}...」設定參數:`;
                domElements.effectParameterOptionsContainer.innerHTML = '';

                Object.entries(Constants.EFFECT_PARAMETERS).forEach(([category, params]) => {
                    const categoryTitle = document.createElement('h4');
                    categoryTitle.textContent = category;
                    domElements.effectParameterOptionsContainer.appendChild(categoryTitle);
                    params.forEach(param => {
                        const label = document.createElement('label');
                        label.className = 'block text-sm text-gray-700 mb-1 items-center';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = param;
                        checkbox.name = 'effectParamOption';
                        checkbox.className = 'mr-2 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 align-middle';
                        if (targetNode.effectParameters && targetNode.effectParameters.includes(param)) { checkbox.checked = true; }
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(param));
                        domElements.effectParameterOptionsContainer.appendChild(label);
                    });
                });
                domElements.effectParameterModal.style.display = 'flex';
            }

            function handleSaveEffectParameters() {
                const state = StateStore.getState();
                if (!state.currentParameterTargetNodeId) return;
                const selectedParams = [];
                domElements.effectParameterOptionsContainer.querySelectorAll('input[name="effectParamOption"]:checked').forEach(checkbox => { selectedParams.push(checkbox.value); });
                RcaProcessor.setEffectParameters(state.currentParameterTargetNodeId, selectedParams);
                domElements.effectParameterModal.style.display = 'none';
                StateStore.setState({ currentParameterTargetNodeId: null }, { pushToHistory: false });
            }

            function openTrizSolutionModal(contradictionNodeId) {
                const state = StateStore.getState();
                if (state.isFinalizedView) return;
                const contradictionNode = RcaProcessor.findNodeById(state.rcaData, contradictionNodeId);
                if (!contradictionNode || !['initial-problem', 'cause', 'positive-effect', 'negative-effect'].includes(contradictionNode.type)) {
                    alert('此節點類型不支援設定衝突參數/方案。');
                    return;
                }

                StateStore.setState({ currentTrizContradictionNodeId: contradictionNodeId }, { pushToHistory: false });

                domElements.trizModalContradictionNodeText.textContent = `衝突節點: ${contradictionNode.text.substring(0,50)}${contradictionNode.text.length > 50 ? '...' : ''}`;
                Utils.populateSelect(domElements.improvingParameterSelect, trizMatrix.getParameters(), true);
                Utils.populateSelect(domElements.worseningParameterSelect, trizMatrix.getParameters(), true);
                Utils.populateSelect(domElements.solutionPrincipleSelect, trizMatrix.getInventivePrinciplesNames(), false);

                domElements.improvingParameterSelect.value = contradictionNode.improvingParameter || "";
                domElements.worseningParameterSelect.value = contradictionNode.worseningParameter || "";

                updateSuggestedPrinciples();
                renderSolutionsListForContradictionNode(contradictionNodeId);
                domElements.editSolutionEntryContainer.style.display = 'none';
                domElements.trizSolutionModal.style.display = 'flex';
            }

            function handleTrizParameterChange() {
                const state = StateStore.getState();
                if (!state.currentTrizContradictionNodeId) return;
                const improvingParam = domElements.improvingParameterSelect.value;
                const worseningParam = domElements.worseningParameterSelect.value;
                RcaProcessor.setTrizParameters(state.currentTrizContradictionNodeId, improvingParam, worseningParam);
                updateSuggestedPrinciples();
            }

            function updateSuggestedPrinciples() {
                const improvingParam = domElements.improvingParameterSelect.value;
                const worseningParam = domElements.worseningParameterSelect.value;
                domElements.suggestedPrinciplesList.innerHTML = '';

                if (improvingParam && worseningParam && improvingParam !== "未選擇" && worseningParam !== "未選擇") {
                    const principlesNames = trizMatrix.getRecommendedPrinciplesByName(improvingParam, worseningParam);
                    if (principlesNames && principlesNames.length > 0) {
                        domElements.suggestedPrinciplesContainer.style.display = 'block';
                        principlesNames.forEach((principleName) => {
                            const li = document.createElement('li');
                            li.textContent = principleName;
                            domElements.suggestedPrinciplesList.appendChild(li);
                        });
                    } else { domElements.suggestedPrinciplesContainer.style.display = 'none'; }
                } else { domElements.suggestedPrinciplesContainer.style.display = 'none'; }
            }

            function renderSolutionsListForContradictionNode(contradictionNodeId) {
                domElements.solutionsListContainer.innerHTML = '';
                const state = StateStore.getState();
                const contradictionNode = RcaProcessor.findNodeById(state.rcaData, contradictionNodeId);
                if (!contradictionNode || !contradictionNode.solutionsGenerated || contradictionNode.solutionsGenerated.length === 0) {
                    domElements.solutionsListContainer.innerHTML = '<p class="text-xs text-gray-500">此衝突節點尚無解決方案。</p>'; return;
                }

                contradictionNode.solutionsGenerated.forEach(sol => {
                    const solDiv = document.createElement('div');
                    solDiv.className = 'solution-entry flex justify-between items-center text-sm';
                    let solText = `<span class="font-semibold">${sol.principleName || '未指定原理'}:</span><span class="ml-2">${sol.description ? sol.description.substring(0, 40) + (sol.description.length > 40 ? '...' : '') : '無描述'}</span>`;
                    if (sol.idealityAssessment && sol.idealityAssessment.weightedScore !== null && sol.idealityAssessment.weightedScore !== undefined) {
                        solText += `<br><span class="text-xs text-gray-500">理想性總分: ${sol.idealityAssessment.weightedScore.toFixed(2)} | 時:${sol.timeRequired ?? '-'} | 成本:${sol.cost ?? '-'}</span>`;
                    } else if (sol.timeRequired !== null || sol.cost !== null) {
                        solText += `<br><span class="text-xs text-gray-500">時:${sol.timeRequired ?? '-'} | 成本:${sol.cost ?? '-'}</span>`;
                    }
                    solDiv.innerHTML = `
                        <div>${solText}</div>
                        <div>
                            <button class="action-button bg-yellow-500 hover:bg-yellow-600 text-xs py-1 px-1.5 mr-1" data-solution-id="${sol.id}" data-action="edit-solution" title="編輯方案"><i class="fas fa-edit"></i></button>
                            <button class="action-button bg-red-500 hover:bg-red-600 text-xs py-1 px-1.5" data-solution-id="${sol.id}" data-action="remove-solution" title="移除方案"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    domElements.solutionsListContainer.appendChild(solDiv);
                });

                domElements.solutionsListContainer.querySelectorAll('button[data-action="edit-solution"]').forEach(btn => {
                    btn.onclick = () => showEditSolutionEntry(btn.dataset.solutionId);
                });
                domElements.solutionsListContainer.querySelectorAll('button[data-action="remove-solution"]').forEach(btn => {
                    btn.onclick = () => RcaProcessor.removeSolutionEntry(contradictionNodeId, btn.dataset.solutionId);
                });
            }

            function showEditSolutionEntry(solutionId) {
                const state = StateStore.getState();
                const contradictionNode = RcaProcessor.findNodeById(state.rcaData, state.currentTrizContradictionNodeId);
                if (!contradictionNode) return;

                const { editingSolutionIdInput, editSolutionTitle, solutionPrincipleSelect, solutionDescriptionInput, solutionTimeRequiredInput, solutionMcdmScoreInput, solutionCostInput, editSolutionEntryContainer } = domElements;

                editingSolutionIdInput.value = solutionId || '';
                if (solutionId) {
                    const solution = contradictionNode.solutionsGenerated.find(s => s.id === solutionId);
                    if (solution) {
                        editSolutionTitle.textContent = "修訂解決方案";
                        solutionPrincipleSelect.value = solution.principleName;
                        solutionDescriptionInput.value = solution.description;
                        solutionTimeRequiredInput.value = solution.timeRequired || '';
                        solutionMcdmScoreInput.value = solution.mcdmScore !== null && solution.mcdmScore !== undefined ? solution.mcdmScore.toFixed(2) : '';
                        solutionCostInput.value = solution.cost || '';
                    } else { return; }
                } else {
                    editSolutionTitle.textContent = "新增解決方案";
                    solutionPrincipleSelect.value = trizMatrix.getInventivePrinciplesNames()[0];
                    solutionDescriptionInput.value = '';
                    solutionTimeRequiredInput.value = '';
                    solutionMcdmScoreInput.value = '';
                    solutionCostInput.value = '';
                }
                editSolutionEntryContainer.style.display = 'block';
                solutionDescriptionInput.focus();
            }

            function handleSaveSolutionEntry() {
                const state = StateStore.getState();
                const { editingSolutionIdInput, solutionPrincipleSelect, solutionDescriptionInput, solutionTimeRequiredInput, solutionCostInput, editSolutionEntryContainer } = domElements;

                const solutionId = editingSolutionIdInput.value;
                const principle = solutionPrincipleSelect.value;
                const description = solutionDescriptionInput.value.trim();
                const timeRequired = solutionTimeRequiredInput.value ? parseFloat(solutionTimeRequiredInput.value) : null;
                const cost = solutionCostInput.value ? parseFloat(solutionCostInput.value) : null;

                if (!principle || principle === "未選擇") { alert("請選擇一個發明原理。"); return; }
                if (!description) { alert("請輸入方案描述。"); return; }

                RcaProcessor.addOrUpdateSolutionEntry(state.currentTrizContradictionNodeId, solutionId, principle, description, timeRequired, cost);

                editSolutionEntryContainer.style.display = 'none';
                editingSolutionIdInput.value = '';
                renderSolutionsListForContradictionNode(state.currentTrizContradictionNodeId);
            }

            function openIdealityAssessmentModal(contradictionNodeId, solutionId) {
                const state = StateStore.getState();
                const contradictionNode = RcaProcessor.findNodeById(state.rcaData, contradictionNodeId);
                if (!contradictionNode || !contradictionNode.solutionsGenerated) { console.error("openIdealityAssessmentModal: 未找到衝突節點或解決方案。", { contradictionNodeId, solutionId, contradictionNode }); return; }
                const solution = contradictionNode.solutionsGenerated.find(s => s.id === solutionId);
                if (!solution) { console.error("openIdealityAssessmentModal: 未找到對應的解決方案。", { contradictionNodeId, solutionId, solution }); return; }

                StateStore.setState({ currentAssessingSolution: { contradictionNodeId, solutionId } }, { pushToHistory: false });

                domElements.assessingSolutionContradictionNodeIdInput.value = contradictionNodeId;
                domElements.assessingSolutionEntryIdInput.value = solutionId;
                domElements.idealityModalSolutionText.textContent = `評估方案: ${solution.description.substring(0,60)}${solution.description.length > 60 ? '...' : ''}`;

                if (!solution.idealityAssessment || !Array.isArray(solution.idealityAssessment.criteria)) {
                    solution.idealityAssessment = Utils.getDefaultIdealityAssessment(state.customIdealityCriteria);
                } else {
                    const newCriteriaState = [];
                    state.customIdealityCriteria.forEach(defaultCrit => {
                        const existingCrit = solution.idealityAssessment.criteria.find(c => c.id === defaultCrit.id);
                        newCriteriaState.push(existingCrit ? { ...existingCrit, name: defaultCrit.name, description: defaultCrit.description } : { ...defaultCrit });
                    });
                    solution.idealityAssessment.criteria = newCriteriaState.filter(crit => state.customIdealityCriteria.some(c => c.id === crit.id));
                }

                domElements.idealityCriteriaContainer.innerHTML = '';
                solution.idealityAssessment.criteria.forEach((crit, index) => {
                    const criterionDiv = document.createElement('div');
                    criterionDiv.className = 'ideality-criterion';
                    criterionDiv.innerHTML = `
                        <label for="ideality-crit-${crit.id}-range">
                            ${index + 1}. ${crit.name} (0-10)
                            <span class="tooltip-container">
                                <i class="fas fa-info-circle text-gray-400 hover:text-gray-600"></i>
                                <span class="tooltip-text">${crit.description}</span>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="ideality-crit-${crit.id}-range" min="0" max="10" value="${crit.score}" class="input-field flex-grow" data-criterion-id="${crit.id}">
                            <span id="ideality-crit-${crit.id}-value" class="range-value">${crit.score}</span>
                        </div>
                        <label for="ideality-crit-${crit.id}-weight" class="text-xs mt-1">
                            權重 (0-1):
                            <input type="number" id="ideality-crit-${crit.id}-weight" value="${crit.weight}" step="0.01" min="0" max="1" class="input-field text-xs p-1 w-20 inline-block ml-1" data-criterion-id="${crit.id}">
                            <span class="tooltip-container">
                                <i class="fas fa-info-circle text-gray-400 hover:text-gray-600"></i>
                                <span class="tooltip-text">
                                    此準則在總分計算中的重要性。所有權重總和建議為 1。
                                    <br>例如：0.25 代表佔 25% 的重要性。
                                </span>
                            </span>
                        </label>
                    `;
                    domElements.idealityCriteriaContainer.appendChild(criterionDiv);

                    const rangeInput = criterionDiv.querySelector(`#ideality-crit-${crit.id}-range`);
                    const valueDisplay = criterionDiv.querySelector(`#ideality-crit-${crit.id}-value`);
                    const weightInput = criterionDiv.querySelector(`#ideality-crit-${crit.id}-weight`);

                    if (rangeInput && valueDisplay) { rangeInput.addEventListener('input', (e) => { valueDisplay.textContent = e.target.value; updateIdealityTotalScoreDisplay(); }); }
                    if (weightInput) { weightInput.addEventListener('input', updateIdealityTotalScoreDisplay); }
                });

                updateIdealityTotalScoreDisplay();
                domElements.idealityAssessmentModal.style.display = 'flex';
            }

            function updateIdealityTotalScoreDisplay() {
                let currentCriteriaScoresAndWeights = [];
                domElements.idealityCriteriaContainer.querySelectorAll('.ideality-criterion').forEach(criterionDiv => {
                    const criterionId = criterionDiv.querySelector('input[type="range"]').dataset.criterionId;
                    const score = parseFloat(criterionDiv.querySelector('input[type="range"]').value);
                    const weight = parseFloat(criterionDiv.querySelector('input[type="number"]').value) || 0;
                    currentCriteriaScoresAndWeights.push({ id: criterionId, score: score, weight: weight });
                });

                let totalWeightedScore = Utils.calculateWeightedScore(currentCriteriaScoresAndWeights);
                let totalWeightSum = currentCriteriaScoresAndWeights.reduce((sum, crit) => sum + crit.weight, 0);

                domElements.idealityTotalScoreDisplay.textContent = totalWeightedScore.toFixed(2);

                if (Math.abs(totalWeightSum - 1.0) > 0.001) {
                    domElements.idealityWeightsSumWarning.textContent = `注意：目前權重總和為 ${totalWeightSum.toFixed(2)}，建議調整至 1.00。`;
                    domElements.idealityWeightsSumWarning.style.display = 'block';
                } else { domElements.idealityWeightsSumWarning.style.display = 'none'; }
            }

            function resetIdealityWeights() {
                const state = StateStore.getState();
                const { contradictionNodeId, solutionId } = state.currentAssessingSolution;
                const contradictionNode = RcaProcessor.findNodeById(state.rcaData, contradictionNodeId);
                const solution = contradictionNode ? contradictionNode.solutionsGenerated.find(s => s.id === solutionId) : null;
                if (!solution || !solution.idealityAssessment) return;

                solution.idealityAssessment.criteria.forEach(crit => {
                    const defaultCrit = state.customIdealityCriteria.find(c => c.id === crit.id);
                    if (defaultCrit) { crit.score = defaultCrit.defaultScore; crit.weight = defaultCrit.defaultWeight; }
                });
                // Re-render the modal content to reflect changes
                openIdealityAssessmentModal(contradictionNodeId, solutionId);
                updateIdealityTotalScoreDisplay();
            }

            function handleSaveIdealityAssessment() {
                const state = StateStore.getState();
                const { contradictionNodeId, solutionId } = state.currentAssessingSolution;
                if (!contradictionNodeId || !solutionId) return;

                let currentCriteria = [];
                domElements.idealityCriteriaContainer.querySelectorAll('.ideality-criterion').forEach(criterionDiv => {
                    const criterionId = criterionDiv.querySelector('input[type="range"]').dataset.criterionId;
                    const score = parseFloat(criterionDiv.querySelector('input[type="range"]').value);
                    const weight = parseFloat(criterionDiv.querySelector('input[type="number"]').value);
                    currentCriteria.push({ id: criterionId, score: score, weight: weight });
                });

                RcaProcessor.updateSolutionIdealityAssessment(contradictionNodeId, solutionId, currentCriteria);
                domElements.idealityAssessmentModal.style.display = 'none';
                StateStore.setState({ currentAssessingSolution: { contradictionNodeId: null, solutionId: null } }, { pushToHistory: false });
            }

            function openSettingsModal() {
                if (domElements.settingsModal) {
                    SettingsManager.renderCustomCriteriaList();
                    SettingsManager.hideEditCriterionForm();
                    domElements.settingsModal.style.display = 'flex';
                }
            }

            return {
                init,
                // openAbcCategoryModal, // 移除原因ABC篩選
                openAndSourceModal,
                openEffectParameterModal,
                openTrizSolutionModal,
                openIdealityAssessmentModal,
                openSettingsModal
            };
        })();

        // --- 10. TableRenderer.js ---
        const TableRenderer = (function() {
            let domElements = {};

            function init(elements) {
                domElements = elements;
                StateStore.subscribe(handleStateChange);
            }

            function handleStateChange(state) {
                // Trigger re-render of tables if relevant data changes
                if (JSON.stringify(state.rcaData) !== JSON.stringify(domElements.causeEffectTableBody.__lastRcaData) ||
                    state.currentAbcSolutionFilter !== domElements.solutionTableBody.__lastAbcSolutionFilter) {
                    renderCauseEffectTable(state.rcaData);
                    renderSolutionTable(state.rcaData, state.currentAbcSolutionFilter);
                    domElements.causeEffectTableBody.__lastRcaData = Utils.deepCopy(state.rcaData);
                    domElements.solutionTableBody.__lastAbcSolutionFilter = state.currentAbcSolutionFilter;
                }
            }

            function renderCauseEffectTable(rcaData) {
                if (!domElements.causeEffectTableBody) return;
                if (!rcaData) { domElements.causeEffectTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; return; }
                const tableData = RcaProcessor.getCauseEffectTableData();
                domElements.causeEffectTableBody.innerHTML = '';
                if (tableData.length === 0) { domElements.causeEffectTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">目前圖表中沒有定義直接帶有正面或負面效果的原因 (且非純粹正面原因)。</td></tr>'; return; }
                tableData.forEach(rowData => {
                    const row = domElements.causeEffectTableBody.insertRow();
                    row.insertCell().textContent = rowData.cause;
                    // row.insertCell().textContent = rowData.abc; // 移除原因ABC篩選
                    row.insertCell().textContent = rowData.type;
                    row.insertCell().textContent = rowData.positive;
                    row.insertCell().textContent = rowData.negative;
                });
            }

            function renderSolutionTable(rcaData, currentAbcSolutionFilter) {
                if (!domElements.solutionTableBody) return;
                if (!rcaData) { domElements.solutionTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; return; }
                const allSolutions = RcaProcessor.getAllSolutionsWithDetails();
                domElements.solutionTableBody.innerHTML = '';

                const filteredSolutions = allSolutions.filter(sol => {
                    if (currentAbcSolutionFilter === 'all') return true;
                    if (currentAbcSolutionFilter === 'none') return !sol.abcCategory;
                    return sol.abcCategory === currentAbcSolutionFilter;
                });

                if (filteredSolutions.length === 0) {
                    let message = '目前沒有符合篩選條件的潛在解決方案。';
                    if (allSolutions.length === 0) { message = '提示：請先找出衝突節點 (同時有`+`和`-`效果)，然後為其「設定衝突參數/方案」。'; }
                    domElements.solutionTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">${message}</td></tr>`; return;
                }

                filteredSolutions.forEach(solDetail => {
                    const row = domElements.solutionTableBody.insertRow();
                    row.insertCell().textContent = solDetail.contradictionNodeText;
                    row.insertCell().textContent = solDetail.improvingParameter || '-';
                    row.insertCell().textContent = solDetail.worseningParameter || '-';
                    row.insertCell().textContent = solDetail.principleName;
                    row.insertCell().textContent = solDetail.description;

                    const abcCell = row.insertCell();
                    const abcSelect = document.createElement('select');
                    abcSelect.classList.add('abc-select');
                    ['-', 'A', 'B', 'C'].forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat === '-' ? '' : cat;
                        option.textContent = cat;
                        if ((solDetail.abcCategory || '') === option.value) { option.selected = true; }
                        abcSelect.appendChild(option);
                    });
                    abcSelect.onchange = (e) => { RcaProcessor.updateSolutionAbcCategory(solDetail.contradictionNodeId, solDetail.solutionId, e.target.value || null); };
                    abcCell.appendChild(abcSelect);

                    const assessCell = row.insertCell();
                    const assessButton = Utils.createActionButton('評估理想性', 'ideality-assess-button bg-blue-500 hover:bg-blue-600', () => {
                        ModalManager.openIdealityAssessmentModal(solDetail.contradictionNodeId, solDetail.solutionId);
                    });
                    assessCell.appendChild(assessButton);

                    const scoreCell = row.insertCell();
                    scoreCell.classList.add('ideality-score-display');
                    scoreCell.textContent = solDetail.mcdmScore !== null && solDetail.mcdmScore !== undefined ? solDetail.mcdmScore.toFixed(2) : '-';
                });
            }

            return {
                init,
                renderCauseEffectTable,
                renderSolutionTable
            };
        })();

        // --- 11. ChartRenderer.js ---
        const ChartRenderer = (function() {
            let domElements = {};
            let ideasLandscapeChartInstance = null;

            function init(elements) {
                domElements = elements;
                StateStore.subscribe(handleStateChange);
                domElements.updateIdeasLandscapeChartButton.addEventListener('click', () => renderIdeasLandscapeChart(StateStore.getState()));
            }

            function handleStateChange(state) {
                // Only re-render chart if relevant data changes
                if (JSON.stringify(StateStore.getState().rcaData) !== JSON.stringify(domElements.ideasLandscapeChartCanvas.__lastRcaData)) {
                    renderIdeasLandscapeChart(state);
                    domElements.ideasLandscapeChartCanvas.__lastRcaData = Utils.deepCopy(state.rcaData);
                }
            }

            function getChartDataPoints(state) {
                const solutions = RcaProcessor.getAllSolutionsWithDetails().filter(s => s.timeRequired !== null && s.mcdmScore !== null && s.mcdmScore !== undefined);
                return solutions.map(sol => ({
                    x: sol.timeRequired,
                    y: sol.mcdmScore,
                    label: sol.description,
                    shortLabel: sol.description.substring(0, 20) + (sol.description.length > 20 ? "..." : ""),
                    cost: sol.cost,
                    abc: sol.abcCategory || 'none',
                    ideality: sol.mcdmScore,
                    id: sol.solutionId
                }));
            }

            function getChartOptions(timeThreshold, scoreThreshold) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '導入所需時間 (單位自訂)', font: { weight: 'bold' } }, grid: { color: '#e5e7eb' } },
                        y: { title: { display: true, text: '理想性加權總分 (MCDM)', font: { weight: 'bold' } }, grid: { color: '#e5e7eb' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.raw.label || '';
                                    if (label) { label = `方案: ${label.substring(0,50)}${label.length > 50 ? '...' : ''}\n`; }
                                    else { label = `方案ID: ${context.raw.id}\n`;}
                                    label += `時間: ${context.raw.x}, 理想性總分: ${context.raw.y.toFixed(2)}`;
                                    if (context.raw.cost !== null && context.raw.cost !== undefined) label += `\n成本: ${context.raw.cost}`;
                                    if (context.raw.abc && context.raw.abc !== 'none') label += `\nABC分類: ${context.raw.abc}`;
                                    return label.split('\n');
                                }
                            },
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFont: { weight: 'bold' },
                            bodyFont: { size: 11 },
                            padding: 10,
                            displayColors: false,
                        },
                        legend: { display: false },
                        quadrantDrawer: { timeThreshold: timeThreshold, scoreThreshold: scoreThreshold }
                    },
                };
            }

            const quadrantPlugin = {
                id: 'quadrantDrawer',
                afterDraw: (chart, args, options) => {
                    const {ctx, chartArea: {left, right, top, bottom}, scales: {x, y}} = chart;
                    const { timeThreshold, scoreThreshold } = options;
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';

                    const xThresholdPixel = x.getPixelForValue(timeThreshold);
                    const yThresholdPixel = y.getPixelForValue(scoreThreshold);

                    const q2 = { x: left, y: top, width: xThresholdPixel - left, height: yThresholdPixel - top };
                    const q1 = { x: xThresholdPixel, y: top, width: right - xThresholdPixel, height: yThresholdPixel - top };
                    const q3 = { x: left, y: yThresholdPixel, width: xThresholdPixel - left, height: bottom - yThresholdPixel };
                    const q4 = { x: xThresholdPixel, y: yThresholdPixel, width: right - xThresholdPixel, height: bottom - yThresholdPixel };

                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q2; if (q2.width > 0 && q2.height > 0) ctx.fillRect(q2.x, q2.y, q2.width, q2.height);
                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q1; if (q1.width > 0 && q1.height > 0) ctx.fillRect(q1.x, q1.y, q1.width, q1.height);
                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q3; if (q3.width > 0 && q3.height > 0) ctx.fillRect(q3.x, q3.y, q3.width, q3.height);
                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q4; if (q4.width > 0 && q4.height > 0) ctx.fillRect(q4.x, q4.y, q4.width, q4.height);
                    ctx.globalCompositeOperation = 'source-over';

                    if (xThresholdPixel >= left && xThresholdPixel <= right) { ctx.beginPath(); ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)'; ctx.lineWidth = 1.5; ctx.setLineDash([6, 3]); ctx.moveTo(xThresholdPixel, top); ctx.lineTo(xThresholdPixel, bottom); ctx.stroke(); ctx.setLineDash([]); }
                    if (yThresholdPixel >= top && yThresholdPixel <= bottom) { ctx.beginPath(); ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)'; ctx.lineWidth = 1.5; ctx.setLineDash([6, 3]); ctx.moveTo(left, yThresholdPixel); ctx.lineTo(right, yThresholdPixel); ctx.stroke(); ctx.setLineDash([]); }

                    ctx.fillStyle = '#374151';
                    ctx.font = 'bold 11px Inter';
                    ctx.textAlign = 'center';
                    const padding = 8;
                    if (q2.width > 20 && q2.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q2, q2.x + q2.width / 2, q2.y + padding + 5);
                    if (q3.width > 20 && q3.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q3, q3.x + q3.width / 2, q3.y + q3.height - padding);
                    if (q1.width > 20 && q1.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q1, q1.x + q1.width / 2, q1.y + padding + 5);
                    if (q4.width > 20 && q4.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q4, q4.x + q4.width / 2, q4.y + q4.height - padding);
                    ctx.restore();
                }
            };
            if (typeof Chart !== 'undefined') { Chart.register(quadrantPlugin); }

            function renderIdeasLandscapeChart(state) {
                if (!domElements.ideasLandscapeChartCanvas || typeof Chart === 'undefined') {
                    if (ideasLandscapeChartInstance) { ideasLandscapeChartInstance.destroy(); ideasLandscapeChartInstance = null; }
                    domElements.ideasLandscapeNoDataMessage.style.display = 'flex'; return;
                }

                const dataPoints = getChartDataPoints(state);
                if (dataPoints.length === 0) {
                    if (ideasLandscapeChartInstance) { ideasLandscapeChartInstance.destroy(); ideasLandscapeChartInstance = null; }
                    domElements.ideasLandscapeNoDataMessage.style.display = 'flex'; return;
                }
                domElements.ideasLandscapeNoDataMessage.style.display = 'none';

                const timeThreshold = parseFloat(domElements.landscapeTimeThresholdInput.value) || 0;
                const scoreThreshold = parseFloat(domElements.landscapeScoreThresholdInput.value) || 0;

                if (ideasLandscapeChartInstance) { ideasLandscapeChartInstance.destroy(); }

                const ctx = domElements.ideasLandscapeChartCanvas.getContext('2d');
                ideasLandscapeChartInstance = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '解決方案創意',
                            data: dataPoints,
                            backgroundColor: dataPoints.map(p => Constants.ABC_COLORS[p.abc] || Constants.ABC_COLORS['none']),
                            borderColor: dataPoints.map(p => Constants.ABC_BORDER_COLORS[p.abc] || Constants.ABC_BORDER_COLORS['none']),
                            borderWidth: 1.5,
                            pointRadius: dataPoints.map(p => Math.min(Math.max(5 + (p.cost !== null && p.cost !== undefined && p.cost > 0 ? Math.log10(p.cost / 100 + 1) * 2 : p.ideality / 2), 4), 15)),
                            pointStyle: dataPoints.map(p => Constants.ABC_POINT_STYLES[p.abc] || Constants.ABC_POINT_STYLES['none']),
                            hoverRadius: dataPoints.map(p => Math.min(Math.max(7 + (p.cost !== null && p.cost !== undefined && p.cost > 0 ? Math.log10(p.cost / 100 + 1) * 2.5 : p.ideality / 1.5), 6), 18)),
                        }]
                    },
                    options: getChartOptions(timeThreshold, scoreThreshold)
                });
            }

            return {
                init,
                renderIdeasLandscapeChart
            };
        })();

        // --- 12. SettingsManager.js ---
        const SettingsManager = (function() {
            let domElements = {};

            function init(elements) {
                domElements = elements;
                StateStore.subscribe(handleStateChange);

                domElements.addNewCriterionButton.addEventListener('click', () => showEditCriterionForm(null));
                domElements.saveCriterionButton.addEventListener('click', handleSaveCriterion);
                domElements.cancelCriterionEditButton.addEventListener('click', hideEditCriterionForm);
                domElements.closeSettingsModalButton.addEventListener('click', () => { domElements.settingsModal.style.display = 'none'; });
            }

            function handleStateChange(state) {
                // Only re-render custom criteria list if customIdealityCriteria changes
                if (JSON.stringify(state.customIdealityCriteria) !== JSON.stringify(domElements.customCriteriaList.__lastCriteria)) {
                    renderCustomCriteriaList(state.customIdealityCriteria);
                    domElements.customCriteriaList.__lastCriteria = Utils.deepCopy(state.customIdealityCriteria);
                }
            }

            function renderCustomCriteriaList(customIdealityCriteria) {
                domElements.customCriteriaList.innerHTML = '';
                if (customIdealityCriteria.length === 0) {
                    domElements.customCriteriaList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">目前沒有自訂評估準則。請新增一個。</p>'; return;
                }

                customIdealityCriteria.forEach(crit => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'criterion-entry';
                    entryDiv.innerHTML = `
                        <span>
                            <strong>${crit.name}</strong>
                            <span class="text-gray-500 text-xs ml-2"> (預設分數: ${crit.defaultScore}, 預設權重: ${crit.defaultWeight})</span>
                        </span>
                        <div>
                            <button class="action-button bg-yellow-500 hover:bg-yellow-600 text-xs py-1 px-1.5" data-criterion-id="${crit.id}" data-action="edit-criterion" title="編輯準則"><i class="fas fa-edit"></i></button>
                            <button class="action-button bg-red-500 hover:bg-red-600 text-xs py-1 px-1.5 ml-1" data-criterion-id="${crit.id}" data-action="remove-criterion" title="移除準則"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    domElements.customCriteriaList.appendChild(entryDiv);
                });

                domElements.customCriteriaList.querySelectorAll('button[data-action="edit-criterion"]').forEach(btn => {
                    btn.onclick = () => showEditCriterionForm(btn.dataset.criterionId);
                });
                domElements.customCriteriaList.querySelectorAll('button[data-action="remove-criterion"]').forEach(btn => {
                    btn.onclick = () => RcaProcessor.removeCriterion(btn.dataset.criterionId);
                });
            }

            function showEditCriterionForm(criterionId) {
                const state = StateStore.getState();
                const { editCriterionForm, criterionFormTitle, editingCriterionIdInput, criterionNameInput, criterionDefaultScoreInput, criterionDefaultWeightInput, criterionDescriptionInput } = domElements;

                editingCriterionIdInput.value = criterionId || '';
                if (criterionId) {
                    const criterion = state.customIdealityCriteria.find(c => c.id === criterionId);
                    if (criterion) {
                        criterionFormTitle.textContent = "編輯評估準則";
                        criterionNameInput.value = criterion.name;
                        criterionDefaultScoreInput.value = criterion.defaultScore;
                        criterionDefaultWeightInput.value = criterion.defaultWeight;
                        criterionDescriptionInput.value = criterion.description;
                    } else { return; }
                } else {
                    criterionFormTitle.textContent = "新增評估準則";
                    criterionNameInput.value = '';
                    criterionDefaultScoreInput.value = 5;
                    criterionDefaultWeightInput.value = 0.25;
                    criterionDescriptionInput.value = '';
                }
                editCriterionForm.style.display = 'block';
                criterionNameInput.focus();
            }

            function hideEditCriterionForm() {
                if (domElements.editCriterionForm) {
                    domElements.editCriterionForm.style.display = 'none';
                    domElements.editingCriterionIdInput.value = '';
                }
            }

            function handleSaveCriterion() {
                const { editingCriterionIdInput, criterionNameInput, criterionDefaultScoreInput, criterionDefaultWeightInput, criterionDescriptionInput } = domElements;

                const criterionId = editingCriterionIdInput.value;
                const name = criterionNameInput.value.trim();
                const defaultScore = parseFloat(criterionDefaultScoreInput.value);
                const defaultWeight = parseFloat(criterionDefaultWeightInput.value);
                const description = criterionDescriptionInput.value.trim();

                if (!name) { alert('準則名稱不能為空！'); return; }
                if (isNaN(defaultScore) || defaultScore < 0 || defaultScore > 10) { alert('預設分數必須是 0 到 10 之間的數字！'); return; }
                if (isNaN(defaultWeight) || defaultWeight < 0 || defaultWeight > 1) { alert('預設權重必須是 0 到 1 之間的數字！'); return; }

                RcaProcessor.addOrUpdateCriterion(criterionId, name, defaultScore, defaultWeight, description);
                hideEditCriterionForm();
            }

            return {
                init,
                renderCustomCriteriaList,
                showEditCriterionForm,
                hideEditCriterionForm
            };
        })();

        // --- 13. UiUtils.js (for general UI state updates) ---
        const UiUtils = {
            updateButtonStates: (state, domElements) => {
                const noData = !state.rcaData;
                const noLocalStorageData = !localStorage.getItem('rcaDiagramData');

                domElements.undoButton.disabled = state.historyIndex <= 0;
                domElements.redoButton.disabled = state.historyIndex >= state.history.length - 1;
                domElements.saveDiagramButton.disabled = noData;
                domElements.loadDiagramButton.disabled = noLocalStorageData;
                domElements.saveToFileButton.disabled = noData;

                domElements.zoomInButton.disabled = state.currentZoom >= Constants.MAX_ZOOM;
                domElements.zoomOutButton.disabled = state.currentZoom <= Constants.MIN_ZOOM;
                domElements.resetZoomButton.disabled = state.currentZoom === 1.0;
                domElements.updateIdeasLandscapeChartButton.disabled = noData;

                [domElements.menuItemToggleView, domElements.menuItemAutoAdjust, domElements.menuItemExportPng,
                 domElements.menuItemCauseEffectTable, domElements.menuItemSolutionTable, domElements.menuItemIdeasLandscape]
                 .forEach(item => { if (item) item.classList.toggle('disabled', noData); });

                // 移除原因ABC篩選按鈕的狀態更新
                // domElements.abcCauseFilterControls.querySelectorAll('button[data-filter-type="cause"]').forEach(button => {
                //     button.classList.toggle('active', button.dataset.filter === state.currentAbcCauseFilter);
                //     button.disabled = noData;
                // });
                domElements.abcSolutionFilterControls.querySelectorAll('button[data-filter-type="solution"]').forEach(button => {
                    button.classList.toggle('active', button.dataset.filter === state.currentAbcSolutionFilter);
                    button.disabled = noData;
                });
            },

            setupDashboardMenu: (domElements) => {
                domElements.mobileMenuButton.addEventListener('click', () => {
                    domElements.dashboardMenu.classList.toggle('-translate-x-full');
                    const icon = domElements.mobileMenuButton.querySelector('i');
                    if (domElements.dashboardMenu.classList.contains('-translate-x-full')) {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                        domElements.mainContentArea.classList.remove('md:ml-0');
                        domElements.mainContentArea.classList.add('md:ml-64');
                    } else {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                        domElements.mainContentArea.classList.remove('md:ml-64');
                        domElements.mainContentArea.classList.add('md:ml-0');
                    }
                });

                document.querySelectorAll('#dashboard-menu .menu-item').forEach(item => {
                    if (item.id === 'sidebar-file-menu-trigger') return;
                    item.addEventListener('click', function(event) {
                        if (this.classList.contains('disabled')) { event.preventDefault(); return; }
                        document.querySelectorAll('#dashboard-menu .menu-item').forEach(i => {
                            if (i.id !== 'sidebar-file-menu-trigger') i.classList.remove('active');
                        });
                        if (this.id !== 'sidebar-file-menu-trigger') this.classList.add('active');

                        const targetId = this.getAttribute('href');
                        if (targetId && targetId.startsWith('#') && targetId.length > 1) {
                            event.preventDefault();
                            document.querySelector(targetId).scrollIntoView({ behavior: 'smooth' });
                        } else if (targetId === '#') { event.preventDefault(); }

                        if (window.innerWidth < 768) {
                            domElements.dashboardMenu.classList.add('-translate-x-full');
                            domElements.mobileMenuButton.querySelector('i').classList.remove('fa-times');
                            domElements.mobileMenuButton.querySelector('i').classList.add('fa-bars');
                            domElements.mainContentArea.classList.add('md:ml-64');
                        }
                    });
                });
            }
        };

        // --- 14. main.js (Entry Point) ---
        document.addEventListener('DOMContentLoaded', () => {
            const domElements = {
                mainToolTitle: document.getElementById('main-tool-title'),
                problemInput: document.getElementById('problem-statement-input'),
                setProblemButton: document.getElementById('set-problem-button'),
                diagramRenderArea: document.getElementById('diagram-render-area'),
                scalableContentWrapper: document.getElementById('scalable-content-wrapper'),
                diagramContainer: document.getElementById('rca-diagram-container'),
                svgLayer: document.getElementById('svg-connector-layer'),
                diagramTitle: document.getElementById('diagram-title'),
                problemInputArea: document.getElementById('problem-input-area'),
                toolButtonsContainer: document.getElementById('tool-buttons'),
                sidebarFileMenuTrigger: document.getElementById('sidebar-file-menu-trigger'),
                fileDropdownContent: document.getElementById('file-dropdown-content'),
                saveDiagramButton: document.getElementById('save-diagram-button'),
                loadDiagramButton: document.getElementById('load-diagram-button'),
                saveToFileButton: document.getElementById('save-to-file-button'),
                loadFromFileLabel: document.getElementById('load-from-file-label'),
                fileInputForLoad: document.getElementById('file-input-for-load'),
                undoButton: document.getElementById('undo-button'),
                redoButton: document.getElementById('redo-button'),
                zoomOutButton: document.getElementById('zoom-out-button'),
                zoomInButton: document.getElementById('zoom-in-button'),
                resetZoomButton: document.getElementById('reset-zoom-button'),
                zoomLevelDisplay: document.getElementById('zoom-level-display'),
                causeEffectTableSection: document.getElementById('cause-effect-table-section'),
                causeEffectTableBody: document.getElementById('cause-effect-table-body'),
                solutionTableSection: document.getElementById('solution-table-section'),
                solutionTableBody: document.getElementById('solution-table-body'),
                abcCategoryModal: document.getElementById('abc-category-modal'),
                // abcCauseFilterControls: document.getElementById('abc-cause-filter-controls'), // 移除原因ABC篩選
                abcSolutionFilterControls: document.getElementById('abc-solution-filter-controls'),
                trizSolutionModal: document.getElementById('triz-solution-modal'),
                trizModalContradictionNodeText: document.getElementById('triz-modal-contradiction-node-text'),
                improvingParameterSelect: document.getElementById('improving-parameter-select'),
                worseningParameterSelect: document.getElementById('worsening-parameter-select'),
                suggestedPrinciplesContainer: document.getElementById('suggested-principles-container'),
                suggestedPrinciplesList: document.getElementById('suggested-principles-list'),
                solutionsListContainer: document.getElementById('solutions-list-container'),
                addNewSolutionEntryButton: document.getElementById('add-new-solution-entry-button'),
                editSolutionEntryContainer: document.getElementById('edit-solution-entry-container'),
                editingSolutionIdInput: document.getElementById('editing-solution-id'),
                solutionPrincipleSelect: document.getElementById('solution-principle-select'),
                solutionDescriptionInput: document.getElementById('solution-description-input'),
                solutionTimeRequiredInput: document.getElementById('solution-time-required-input'),
                solutionMcdmScoreInput: document.getElementById('solution-mcdm-score-input'),
                solutionCostInput: document.getElementById('solution-cost-input'),
                saveSolutionEntryButton: document.getElementById('save-solution-entry-button'),
                cancelEditSolutionButton: document.getElementById('cancel-edit-solution-button'),
                editSolutionTitle: document.getElementById('edit-solution-title'),
                closeTrizModalButton: document.getElementById('close-triz-modal-button'),
                ideasLandscapeSection: document.getElementById('ideas-landscape-section'),
                ideasLandscapeChartCanvas: document.getElementById('ideas-landscape-chart'),
                ideasLandscapeNoDataMessage: document.getElementById('ideas-landscape-no-data-message'),
                updateIdeasLandscapeChartButton: document.getElementById('update-ideas-landscape-chart-button'),
                landscapeTimeThresholdInput: document.getElementById('landscape-time-threshold'),
                landscapeScoreThresholdInput: document.getElementById('landscape-score-threshold'),
                idealityAssessmentModal: document.getElementById('ideality-assessment-modal'),
                idealityModalSolutionText: document.getElementById('ideality-modal-solution-text'),
                assessingSolutionContradictionNodeIdInput: document.getElementById('assessing-solution-contradiction-node-id'),
                assessingSolutionEntryIdInput: document.getElementById('assessing-solution-entry-id'),
                idealityCriteriaContainer: document.getElementById('ideality-criteria-container'),
                idealityTotalScoreDisplay: document.getElementById('ideality-total-score-display'),
                idealityWeightsSumWarning: document.getElementById('ideality-weights-sum-warning'),
                saveIdealityAssessmentButton: document.getElementById('save-ideality-assessment-button'),
                cancelIdealityAssessmentButton: document.getElementById('cancel-ideality-assessment-button'),
                resetIdealityWeightsButton: document.getElementById('reset-ideality-weights-button'),
                andSourceModal: document.getElementById('and-source-modal'),
                andSourceModalNodeText: document.getElementById('and-source-modal-node-text'),
                andSourceOptionsContainer: document.getElementById('and-source-options-container'),
                cancelAndSourcesButton: document.getElementById('cancel-and-sources-button'),
                saveAndSourcesButton: document.getElementById('save-and-sources-button'),
                effectParameterModal: document.getElementById('effect-parameter-modal'),
                effectParameterModalNodeText: document.getElementById('effect-parameter-modal-node-text'),
                effectParameterOptionsContainer: document.getElementById('effect-parameter-options-container'),
                cancelEffectParametersButton: document.getElementById('cancel-effect-parameters-button'),
                saveEffectParametersButton: document.getElementById('save-effect-parameters-button'),
                dashboardMenu: document.getElementById('dashboard-menu'),
                mobileMenuButton: document.getElementById('mobile-menu-button'),
                mainContentArea: document.getElementById('main-content-area'),
                menuItemToggleView: document.getElementById('menu-item-toggle-view'),
                menuItemAutoAdjust: document.getElementById('menu-item-auto-adjust'),
                menuItemExportPng: document.getElementById('menu-item-export-png'),
                menuItemCauseEffectTable: document.getElementById('menu-item-cause-effect-table'),
                menuItemSolutionTable: document.getElementById('menu-item-solution-table'),
                menuItemIdeasLandscape: document.getElementById('menu-item-ideas-landscape'),
                menuItemSettings: document.getElementById('menu-item-settings'),
                closeSettingsModalButton: document.getElementById('close-settings-modal-button'),
                customCriteriaList: document.getElementById('custom-criteria-list'),
                addNewCriterionButton: document.getElementById('add-new-criterion-button'),
                editCriterionForm: document.getElementById('edit-criterion-form'),
                criterionFormTitle: document.getElementById('criterion-form-title'),
                editingCriterionIdInput: document.getElementById('editing-criterion-id'),
                criterionNameInput: document.getElementById('criterion-name-input'),
                criterionDefaultScoreInput: document.getElementById('criterion-default-score-input'),
                criterionDefaultWeightInput: document.getElementById('criterion-default-weight-input'),
                criterionDescriptionInput: document.getElementById('criterion-description-input'),
                cancelCriterionEditButton: document.getElementById('cancel-criterion-edit-button'),
                saveCriterionButton: document.getElementById('save-criterion-button')
            };

            // Initialize modules
            StateStore.initializeDefaultCriteria();
            RcaDiagramRenderer.init(domElements);
            ModalManager.init(domElements);
            TableRenderer.init(domElements);
            ChartRenderer.init(domElements);
            SettingsManager.init(domElements);

            // Setup top-level event listeners
            domElements.setProblemButton.addEventListener('click', () => RcaProcessor.setInitialProblem(domElements.problemInput.value.trim()));
            domElements.problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') RcaProcessor.setInitialProblem(domElements.problemInput.value.trim()); });

            domElements.sidebarFileMenuTrigger.addEventListener('click', (event) => {
                event.stopPropagation();
                const isDisplayed = domElements.fileDropdownContent.style.display === 'block';
                domElements.fileDropdownContent.style.display = isDisplayed ? 'none' : 'block';
                if (!isDisplayed) { UiUtils.updateButtonStates(StateStore.getState(), domElements); }
            });
            domElements.saveDiagramButton.addEventListener('click', () => { DataManager.saveToLocalStorage(); domElements.fileDropdownContent.style.display = 'none'; });
            domElements.loadDiagramButton.addEventListener('click', () => { DataManager.loadFromLocalStorage(); domElements.fileDropdownContent.style.display = 'none'; });
            domElements.saveToFileButton.addEventListener('click', () => { DataManager.saveToFile(); domElements.fileDropdownContent.style.display = 'none'; });
            domElements.loadFromFileLabel.addEventListener('click', () => { domElements.fileInputForLoad.click(); });
            domElements.fileInputForLoad.addEventListener('change', (event) => { DataManager.loadFromFile(event); domElements.fileDropdownContent.style.display = 'none'; });

            domElements.undoButton.addEventListener('click', HistoryManager.undo);
            domElements.redoButton.addEventListener('click', HistoryManager.redo);

            domElements.zoomInButton.addEventListener('click', () => RcaDiagramRenderer.applyZoom(StateStore.getState().currentZoom + Constants.ZOOM_STEP));
            domElements.zoomOutButton.addEventListener('click', () => RcaDiagramRenderer.applyZoom(StateStore.getState().currentZoom - Constants.ZOOM_STEP));
            domElements.resetZoomButton.addEventListener('click', () => RcaDiagramRenderer.applyZoom(1.0));

            // 移除原因ABC篩選的事件監聽器
            // domElements.abcCauseFilterControls.querySelectorAll('button[data-filter-type="cause"]').forEach(button => {
            //     button.addEventListener('click', (event) => {
            //         const filterType = event.target.dataset.filter;
            //         StateStore.setState({ currentAbcCauseFilter: filterType });
            //     });
            // });
            domElements.abcSolutionFilterControls.querySelectorAll('button[data-filter-type="solution"]').forEach(button => {
                button.addEventListener('click', (event) => {
                    const filterType = event.target.dataset.filter;
                    StateStore.setState({ currentAbcSolutionFilter: filterType });
                });
            });

            // Dashboard menu setup
            UiUtils.setupDashboardMenu(domElements);
            domElements.menuItemToggleView.addEventListener('click', (e) => { e.preventDefault(); if (!domElements.menuItemToggleView.classList.contains('disabled')) StateStore.setState({ isFinalizedView: !StateStore.getState().isFinalizedView }); });
            domElements.menuItemAutoAdjust.addEventListener('click', (e) => { e.preventDefault(); if (!domElements.menuItemAutoAdjust.classList.contains('disabled')) alert('自動調整節點功能尚待開發。'); });
            domElements.menuItemExportPng.addEventListener('click', (e) => { e.preventDefault(); if (!domElements.menuItemExportPng.classList.contains('disabled')) RcaDiagramRenderer.exportAsPNG(); });

            domElements.menuItemCauseEffectTable.addEventListener('click', (e) => { e.preventDefault(); if (!domElements.menuItemCauseEffectTable.classList.contains('disabled')) domElements.causeEffectTableSection.style.display = domElements.causeEffectTableSection.style.display === 'none' ? 'block' : 'none'; });
            domElements.menuItemSolutionTable.addEventListener('click', (e) => { e.preventDefault(); if (!domElements.menuItemSolutionTable.classList.contains('disabled')) domElements.solutionTableSection.style.display = domElements.solutionTableSection.style.display === 'none' ? 'block' : 'none'; });
            domElements.menuItemIdeasLandscape.addEventListener('click', (e) => { e.preventDefault(); if (!domElements.menuItemIdeasLandscape.classList.contains('disabled')) domElements.ideasLandscapeSection.style.display = domElements.ideasLandscapeSection.style.display === 'none' ? 'block' : 'none'; });
            domElements.menuItemSettings.addEventListener('click', (e) => { e.preventDefault(); ModalManager.openSettingsModal(); });

            window.addEventListener('click', (event) => {
                if (domElements.fileDropdownContent && domElements.sidebarFileMenuTrigger &&
                    !domElements.sidebarFileMenuTrigger.contains(event.target) &&
                    !domElements.fileDropdownContent.contains(event.target)) {
                    domElements.fileDropdownContent.style.display = 'none';
                }
            });

            // Initial render based on current state
            RcaDiagramRenderer.renderDiagram(StateStore.getState().rcaData, StateStore.getState().isFinalizedView); // 移除 currentAbcCauseFilter
            TableRenderer.renderCauseEffectTable(StateStore.getState().rcaData);
            TableRenderer.renderSolutionTable(StateStore.getState().rcaData, StateStore.getState().currentAbcSolutionFilter);
            ChartRenderer.renderIdeasLandscapeChart(StateStore.getState());
            SettingsManager.renderCustomCriteriaList(StateStore.getState().customIdealityCriteria);
            UiUtils.updateButtonStates(StateStore.getState(), domElements);

            // Subscribe to state changes to trigger UI updates
            StateStore.subscribe(state => {
                // Dashboard menu item text/icon update for view mode
                const menuItem = domElements.menuItemToggleView;
                const icon = menuItem.querySelector('i');
                icon.className = state.isFinalizedView ? 'fas fa-lock fa-fw mr-3' : 'fas fa-edit fa-fw mr-3';
                menuItem.innerHTML = `<i class="${icon.className}"></i> ${state.isFinalizedView ? '檢視模式 (已鎖定)' : '編輯模式'}`;

                // Other UI updates handled by individual modules via their subscriptions
                UiUtils.updateButtonStates(state, domElements);
            });
        });
    </script>
</body>
</html>
